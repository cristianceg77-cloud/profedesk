<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ProfeDesk ¬∑ Econom√≠a</title>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --ink:#1a1a2e; --paper:#f5f0e8; --accent:#c0392b;
    --gold:#d4a017; --sage:#4a7c59; --muted:#8a8070;
    --card:#fffdf8; --border:#e0d8c8;
  }
  *{margin:0;padding:0;box-sizing:border-box;}
  body{font-family:'DM Sans',sans-serif;background:var(--paper);color:var(--ink);min-height:100vh;}

  header{background:var(--ink);color:var(--paper);padding:1rem 2rem;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:200;border-bottom:3px solid var(--gold);}
  .logo{font-family:'Playfair Display',serif;font-size:1.4rem;}
  .logo span{color:var(--gold);}
  .date-badge{font-size:.78rem;color:rgba(255,255,255,.5);background:rgba(255,255,255,.08);padding:.35rem .8rem;border-radius:20px;}

  .nav-tabs{display:flex;background:var(--ink);padding:0 1.5rem;border-bottom:1px solid rgba(255,255,255,.1);overflow-x:auto;}
  .nav-tab{padding:.7rem 1.1rem;font-size:.82rem;font-weight:500;color:rgba(255,255,255,.45);cursor:pointer;border-bottom:3px solid transparent;transition:all .2s;white-space:nowrap;}
  .nav-tab:hover{color:rgba(255,255,255,.85);}
  .nav-tab.active{color:var(--gold);border-bottom-color:var(--gold);}

  main{padding:1.5rem 2rem;max-width:1100px;margin:0 auto;}
  .tab-content{display:none;}
  .tab-content.active{display:block;animation:fadeIn .3s ease;}
  @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}

  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:1.4rem;margin-bottom:1.2rem;}
  .card-title{font-family:'Playfair Display',serif;font-size:1rem;margin-bottom:1rem;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:.5rem;}

  .school-bar{display:flex;gap:.6rem;flex-wrap:wrap;margin-bottom:1.1rem;align-items:center;}
  .school-pill{padding:.45rem 1rem;border-radius:30px;border:2px solid var(--border);background:var(--card);font-size:.8rem;font-weight:600;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:.4rem;}
  .school-pill .dot{width:8px;height:8px;border-radius:50%;}
  .school-pill.s0 .dot{background:#888;}
  .school-pill.s1 .dot{background:var(--accent);}
  .school-pill.s2 .dot{background:var(--sage);}
  .school-pill.s3 .dot{background:var(--gold);}
  .school-pill.active.s0{background:var(--ink);color:white;border-color:var(--ink);}
  .school-pill.active.s1{background:var(--accent);color:white;border-color:var(--accent);}
  .school-pill.active.s2{background:var(--sage);color:white;border-color:var(--sage);}
  .school-pill.active.s3{background:var(--gold);color:var(--ink);border-color:var(--gold);}
  .school-pill:hover{transform:translateY(-2px);box-shadow:0 4px 10px rgba(0,0,0,.1);}

  .btn{padding:.5rem 1rem;border-radius:8px;border:none;font-family:'DM Sans',sans-serif;font-size:.82rem;font-weight:600;cursor:pointer;transition:all .2s;display:inline-flex;align-items:center;gap:.35rem;}
  .btn-primary{background:var(--ink);color:var(--paper);}
  .btn-primary:hover{background:#2d2d50;}
  .btn-success{background:var(--sage);color:white;}
  .btn-success:hover{background:#3a6347;}
  .btn-danger{background:var(--accent);color:white;}
  .btn-danger:hover{background:#a93226;}
  .btn-ghost{background:transparent;color:var(--muted);border:1px solid var(--border);}
  .btn-ghost:hover{background:var(--border);}
  .btn-sm{padding:.28rem .65rem;font-size:.74rem;}
  .btn-icon{background:none;border:none;cursor:pointer;font-size:1rem;padding:.2rem;transition:transform .15s;}
  .btn-icon:hover{transform:scale(1.2);}

  input,select,textarea{font-family:'DM Sans',sans-serif;font-size:.85rem;border:1px solid var(--border);border-radius:8px;padding:.5rem .75rem;background:var(--paper);color:var(--ink);width:100%;transition:border .2s;}
  input:focus,select:focus,textarea:focus{outline:2px solid var(--gold);border-color:var(--gold);}
  label{font-size:.76rem;font-weight:600;color:var(--muted);display:block;margin-bottom:.25rem;text-transform:uppercase;letter-spacing:.5px;}

  /* MODALS */
  .modal-bg{display:none;position:fixed;inset:0;background:rgba(26,26,46,.55);backdrop-filter:blur(3px);z-index:300;align-items:center;justify-content:center;}
  .modal-bg.open{display:flex;}
  .modal{background:var(--card);border-radius:16px;padding:2rem;width:90%;max-width:520px;box-shadow:0 20px 60px rgba(0,0,0,.25);animation:modalIn .25s ease;max-height:90vh;overflow-y:auto;}
  @keyframes modalIn{from{opacity:0;transform:scale(.95)}to{opacity:1;transform:scale(1)}}
  .modal-title{font-family:'Playfair Display',serif;font-size:1.2rem;margin-bottom:1.2rem;}
  .form-row{margin-bottom:.85rem;}
  .form-actions{display:flex;gap:.6rem;justify-content:flex-end;margin-top:1.2rem;}
  .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:.7rem;}

  /* TABLES */
  table{width:100%;border-collapse:collapse;font-size:.85rem;}
  th{text-align:left;font-size:.7rem;text-transform:uppercase;letter-spacing:.7px;color:var(--muted);padding:.5rem .8rem;border-bottom:2px solid var(--border);}
  td{padding:.6rem .8rem;border-bottom:1px solid var(--border);vertical-align:middle;}
  tr:hover td{background:var(--paper);}
  tr:last-child td{border-bottom:none;}

  .avatar{width:30px;height:30px;border-radius:50%;background:var(--ink);color:var(--paper);display:inline-flex;align-items:center;justify-content:center;font-size:.63rem;font-weight:700;margin-right:.5rem;flex-shrink:0;}
  .nota-badge{display:inline-block;min-width:32px;text-align:center;padding:.15rem .3rem;border-radius:6px;font-weight:700;font-size:.78rem;}
  .nota-a{background:rgba(74,124,89,.15);color:var(--sage);}
  .nota-b{background:rgba(212,160,23,.15);color:#9a7000;}
  .nota-c{background:rgba(192,57,43,.15);color:var(--accent);}

  /* ASISTENCIA */
  .asist-list{display:flex;flex-direction:column;gap:.45rem;}
  .asist-row{display:flex;align-items:center;gap:.7rem;padding:.6rem .85rem;border:1px solid var(--border);border-radius:10px;background:var(--paper);transition:all .2s;}
  .asist-nombre{flex:1;font-size:.86rem;font-weight:500;}
  .asist-btns{display:flex;gap:.35rem;}
  .asist-btn{width:34px;height:34px;border-radius:8px;border:2px solid var(--border);background:white;font-size:.82rem;cursor:pointer;font-weight:700;transition:all .15s;display:flex;align-items:center;justify-content:center;}
  .asist-btn:hover{transform:scale(1.08);}
  .asist-btn.selected-P{background:#4a7c59;border-color:#4a7c59;color:white;}
  .asist-btn.selected-A{background:#c0392b;border-color:#c0392b;color:white;}
  .asist-btn.selected-T{background:#d4a017;border-color:#d4a017;color:var(--ink);}
  .asist-row.estado-P{border-color:rgba(74,124,89,.4);background:rgba(74,124,89,.04);}
  .asist-row.estado-A{border-color:rgba(192,57,43,.3);background:rgba(192,57,43,.03);}
  .asist-row.estado-T{border-color:rgba(212,160,23,.4);background:rgba(212,160,23,.04);}

  /* nota inline en asistencia */
  .nota-inline{width:52px;font-size:.8rem;padding:.28rem .4rem;text-align:center;background:white;border:1px solid var(--border);border-radius:6px;}
  .nota-inline:focus{outline:2px solid var(--gold);}
  .nota-inline-label{font-size:.65rem;color:var(--muted);text-align:center;display:block;margin-top:.15rem;}

  .asist-summary{display:flex;gap:.8rem;font-size:.8rem;font-weight:600;margin-bottom:1rem;flex-wrap:wrap;align-items:center;}
  .asist-summary span{padding:.28rem .75rem;border-radius:20px;}
  .sum-P{background:rgba(74,124,89,.12);color:var(--sage);}
  .sum-A{background:rgba(192,57,43,.12);color:var(--accent);}
  .sum-T{background:rgba(212,160,23,.15);color:#9a7000;}

  /* HISTORIAL */
  .hist-dots{display:flex;gap:.25rem;flex-wrap:wrap;margin-top:.25rem;}
  .hist-dot{width:11px;height:11px;border-radius:50%;cursor:pointer;position:relative;}
  .hist-dot:hover::after{content:attr(data-tip);position:absolute;bottom:130%;left:50%;transform:translateX(-50%);background:var(--ink);color:white;padding:.2rem .5rem;border-radius:5px;font-size:.65rem;white-space:nowrap;z-index:10;pointer-events:none;}
  .hP{background:var(--sage);}
  .hA{background:var(--accent);}
  .hT{background:var(--gold);}
  .hN{background:var(--border);}

  /* historial modal */
  .hist-table td,.hist-table th{padding:.4rem .6rem;font-size:.8rem;}
  .hist-legend{display:flex;gap:1rem;font-size:.75rem;margin-bottom:.8rem;flex-wrap:wrap;}
  .hist-legend span{display:flex;align-items:center;gap:.35rem;}
  .legend-dot{width:10px;height:10px;border-radius:50%;display:inline-block;}

  /* ESCUELAS */
  .escuela-card{display:flex;align-items:center;gap:1rem;padding:1rem 1.2rem;border:1px solid var(--border);border-radius:12px;background:var(--paper);margin-bottom:.7rem;transition:all .2s;}
  .escuela-card:hover{box-shadow:0 4px 14px rgba(0,0,0,.08);}
  .esc-dot{width:14px;height:14px;border-radius:50%;flex-shrink:0;}
  .esc-info{flex:1;}
  .esc-nombre{font-weight:700;font-size:.95rem;}
  .esc-meta{font-size:.75rem;color:var(--muted);margin-top:.15rem;}
  .esc-actions{display:flex;gap:.5rem;}

  /* TOAST */
  .toast{position:fixed;bottom:2rem;right:2rem;background:var(--ink);color:var(--paper);padding:.75rem 1.3rem;border-radius:10px;font-size:.83rem;font-weight:500;z-index:999;transform:translateY(80px);opacity:0;transition:all .3s;border-left:3px solid var(--gold);}
  .toast.show{transform:translateY(0);opacity:1;}

  /* STATS */
  .stats-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(155px,1fr));gap:1rem;margin-bottom:1.2rem;}
  .stat-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:1.1rem 1.3rem;position:relative;overflow:hidden;}
  .stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;}
  .stat-card.red::before{background:var(--accent);}
  .stat-card.green::before{background:var(--sage);}
  .stat-card.gold::before{background:var(--gold);}
  .stat-card.ink::before{background:var(--ink);}
  .stat-label{font-size:.7rem;color:var(--muted);text-transform:uppercase;letter-spacing:.7px;margin-bottom:.3rem;}
  .stat-value{font-family:'Playfair Display',serif;font-size:1.9rem;font-weight:700;line-height:1;}
  .stat-sub{font-size:.73rem;color:var(--muted);margin-top:.2rem;}

  .empty-state{text-align:center;padding:3rem 1rem;color:var(--muted);}
  .empty-state .big{font-size:2.5rem;margin-bottom:.5rem;}
  .search-wrap{position:relative;margin-bottom:1rem;}
  .search-wrap input{padding-left:2.1rem;}
  .search-icon{position:absolute;left:.7rem;top:50%;transform:translateY(-50%);color:var(--muted);font-size:.88rem;pointer-events:none;}
  .section-title{font-family:'Playfair Display',serif;font-size:1.3rem;margin-bottom:1rem;}
  .divider{border:none;border-top:1px solid var(--border);margin:1rem 0;}

  /* NOTIFICACI√ìN SPLASH */
  .notif-overlay{display:none;position:fixed;inset:0;background:rgba(26,26,46,.6);backdrop-filter:blur(4px);z-index:500;align-items:center;justify-content:center;}
  .notif-overlay.open{display:flex;}
  .notif-box{background:var(--card);border-radius:18px;padding:2rem;width:90%;max-width:460px;box-shadow:0 24px 70px rgba(0,0,0,.3);animation:modalIn .3s ease;border-top:4px solid var(--gold);}
  .notif-header{display:flex;align-items:center;gap:.8rem;margin-bottom:1.2rem;}
  .notif-icon{font-size:1.8rem;}
  .notif-title{font-family:'Playfair Display',serif;font-size:1.15rem;}
  .notif-item{display:flex;gap:.8rem;align-items:flex-start;padding:.65rem .8rem;border-radius:10px;margin-bottom:.5rem;border-left:3px solid transparent;}
  .notif-item.hoy{background:rgba(192,57,43,.07);border-color:var(--accent);}
  .notif-item.pronto{background:rgba(212,160,23,.08);border-color:var(--gold);}
  .notif-item.proximo{background:rgba(74,124,89,.06);border-color:var(--sage);}
  .notif-badge{font-size:.68rem;font-weight:700;padding:.15rem .5rem;border-radius:6px;white-space:nowrap;flex-shrink:0;margin-top:.1rem;}
  .nb-hoy{background:rgba(192,57,43,.15);color:var(--accent);}
  .nb-pronto{background:rgba(212,160,23,.15);color:#9a7000;}
  .nb-proximo{background:rgba(74,124,89,.15);color:var(--sage);}
  .notif-ev-title{font-size:.88rem;font-weight:600;}
  .notif-ev-meta{font-size:.75rem;color:var(--muted);margin-top:.1rem;}

  /* CALENDARIO */
  .cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:2px;margin-top:.5rem;}
  .cal-day-header{text-align:center;font-size:.68rem;font-weight:700;color:var(--muted);padding:.3rem 0;text-transform:uppercase;}
  .cal-cell{min-height:58px;border-radius:8px;padding:.35rem .4rem;border:1px solid transparent;transition:all .15s;position:relative;background:var(--paper);}
  .cal-cell.other-month{opacity:.35;}
  .cal-cell.today{border-color:var(--gold);background:rgba(212,160,23,.07);}
  .cal-cell.has-event{cursor:pointer;}
  .cal-cell.has-event:hover{background:rgba(26,26,46,.05);transform:scale(1.02);}
  .cal-num{font-size:.78rem;font-weight:600;color:var(--muted);margin-bottom:.2rem;}
  .cal-cell.today .cal-num{color:var(--gold);font-weight:800;}
  .cal-event-dot{font-size:.62rem;font-weight:700;padding:.1rem .35rem;border-radius:4px;margin-bottom:.15rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%;display:block;}
  .cev-examen{background:rgba(192,57,43,.15);color:var(--accent);}
  .cev-notas{background:rgba(74,124,89,.15);color:var(--sage);}
  .cev-evento{background:rgba(212,160,23,.15);color:#9a7000;}
  .cev-feriado{background:rgba(125,60,152,.15);color:#7d3c98;}
  .cev-jornada{background:rgba(36,113,163,.15);color:#2471a3;}
  .cev-acto{background:rgba(22,160,133,.15);color:#16a085;}
  .cal-nav{display:flex;align-items:center;justify-content:space-between;margin-bottom:.8rem;}
  .cal-nav-btn{background:none;border:1px solid var(--border);border-radius:8px;padding:.35rem .8rem;cursor:pointer;font-size:.9rem;transition:all .15s;}
  .cal-nav-btn:hover{background:var(--border);}
  .cal-month-label{font-family:'Playfair Display',serif;font-size:1rem;font-weight:700;}

  /* LISTA EVENTOS */
  .ev-item{display:flex;align-items:center;gap:.8rem;padding:.7rem .9rem;border-radius:10px;border:1px solid var(--border);margin-bottom:.5rem;background:var(--paper);transition:all .15s;}
  .ev-item:hover{box-shadow:0 3px 10px rgba(0,0,0,.08);}
  .ev-type-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;}
  .ev-info{flex:1;}
  .ev-nombre{font-size:.88rem;font-weight:600;}
  .ev-meta{font-size:.74rem;color:var(--muted);margin-top:.1rem;}

  /* PR√ìXIMOS en Inicio */
  .prox-item{display:flex;align-items:center;gap:.7rem;padding:.55rem .7rem;border-radius:9px;border-left:3px solid;font-size:.84rem;margin-bottom:.4rem;}
  .prox-item.tipo-examen{border-color:var(--accent);background:rgba(192,57,43,.05);}
  .prox-item.tipo-notas{border-color:var(--sage);background:rgba(74,124,89,.05);}
  .prox-item.tipo-evento{border-color:var(--gold);background:rgba(212,160,23,.05);}
  .prox-nombre{flex:1;font-weight:600;}
  .prox-fecha{font-size:.72rem;color:var(--muted);}
  .dias-badge{font-size:.7rem;font-weight:700;padding:.15rem .45rem;border-radius:5px;}
  .db-hoy{background:rgba(192,57,43,.12);color:var(--accent);}
  .db-pronto{background:rgba(212,160,23,.12);color:#9a7000;}
  .db-ok{background:rgba(74,124,89,.1);color:var(--sage);}
  .db-past{background:var(--border);color:var(--muted);}


  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     HORARIO
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  .horario-vista-btns{display:flex;gap:.5rem;margin-bottom:1.2rem;}
  .vista-btn{padding:.45rem 1.1rem;border-radius:8px;border:2px solid var(--border);background:var(--card);font-size:.82rem;font-weight:600;cursor:pointer;transition:all .2s;}
  .vista-btn.active{background:var(--ink);color:var(--paper);border-color:var(--ink);}

  /* GRILLA SEMANAL */
  .horario-grid{display:grid;grid-template-columns:70px repeat(5,1fr);gap:3px;font-size:.78rem;}
  .hg-header{text-align:center;font-weight:700;font-size:.72rem;padding:.5rem .3rem;border-radius:6px;text-transform:uppercase;letter-spacing:.5px;}
  .hg-header.dia-hoy{background:rgba(212,160,23,.15);color:var(--gold);}
  .hg-turno-label{display:flex;align-items:center;justify-content:center;font-size:.65rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.6px;writing-mode:vertical-rl;text-orientation:mixed;padding:.3rem 0;border-radius:6px 0 0 6px;}
  .hg-turno-label.t-manana{background:rgba(212,160,23,.08);}
  .hg-turno-label.t-tarde{background:rgba(192,57,43,.07);}
  .hg-turno-label.t-noche{background:rgba(36,113,163,.08);}
  .hg-slot{min-height:64px;border-radius:6px;border:1px dashed var(--border);cursor:pointer;transition:all .15s;display:flex;flex-direction:column;gap:2px;padding:3px;background:var(--paper);}
  .hg-slot:hover{border-color:var(--gold);background:rgba(212,160,23,.04);}
  .hg-slot.t-manana{background:rgba(212,160,23,.03);}
  .hg-slot.t-tarde{background:rgba(192,57,43,.02);}
  .hg-slot.t-noche{background:rgba(36,113,163,.03);}
  .hg-clase{border-radius:5px;padding:.25rem .35rem;font-size:.68rem;font-weight:600;line-height:1.3;cursor:pointer;transition:all .15s;}
  .hg-clase:hover{filter:brightness(.92);}
  .hg-clase .hc-nombre{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  .hg-clase .hc-meta{font-weight:400;opacity:.8;font-size:.62rem;}
  .hg-add-btn{width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:var(--border);font-size:1.1rem;border:none;background:none;cursor:pointer;}
  .hg-add-btn:hover{color:var(--gold);}

  /* TURNO SEPARATORS en grilla */
  .hg-sep{grid-column:1/-1;height:6px;}

  /* VISTA D√çA */
  .dia-nav{display:flex;align-items:center;gap:.8rem;margin-bottom:1rem;}
  .dia-nav-btn{background:none;border:1px solid var(--border);border-radius:8px;padding:.3rem .8rem;cursor:pointer;font-size:.9rem;transition:all .15s;}
  .dia-nav-btn:hover{background:var(--border);}
  .dia-nombre{font-family:'Playfair Display',serif;font-size:1.1rem;font-weight:700;}

  .turno-section{margin-bottom:1rem;}
  .turno-header{display:flex;align-items:center;gap:.6rem;padding:.5rem .8rem;border-radius:8px;font-size:.78rem;font-weight:700;text-transform:uppercase;letter-spacing:.5px;margin-bottom:.5rem;}
  .turno-header.t-manana{background:rgba(212,160,23,.12);color:#9a7000;}
  .turno-header.t-tarde{background:rgba(192,57,43,.1);color:var(--accent);}
  .turno-header.t-noche{background:rgba(36,113,163,.12);color:#1a5276;}
  .turno-clases{display:flex;flex-direction:column;gap:.4rem;}

  .clase-card{display:flex;align-items:center;gap:.9rem;padding:.7rem 1rem;border-radius:10px;border-left:4px solid;background:var(--card);border-top:1px solid var(--border);border-right:1px solid var(--border);border-bottom:1px solid var(--border);transition:all .15s;}
  .clase-card:hover{box-shadow:0 3px 12px rgba(0,0,0,.08);}
  .clase-hora{font-size:.75rem;font-weight:700;color:var(--muted);white-space:nowrap;min-width:80px;}
  .clase-info{flex:1;}
  .clase-nombre{font-weight:700;font-size:.9rem;}
  .clase-meta{font-size:.76rem;color:var(--muted);margin-top:.1rem;}
  .clase-escuela-badge{font-size:.68rem;font-weight:700;padding:.15rem .45rem;border-radius:5px;color:white;}
  .clase-acciones{display:flex;gap:.3rem;}
  .empty-turno{color:var(--muted);font-size:.82rem;padding:.5rem .8rem;font-style:italic;}

  /* MODAL CLASE */
  .time-row{display:grid;grid-template-columns:1fr 1fr;gap:.7rem;}

  /* SEGUIMIENTO */
  .seg-indicador-header{
    display:grid;grid-template-columns:1fr repeat(4,110px) 90px 180px;
    gap:.4rem;align-items:center;
    padding:.5rem .9rem;font-size:.68rem;font-weight:700;
    text-transform:uppercase;letter-spacing:.6px;color:var(--muted);
    border-bottom:2px solid var(--border);
  }
  .seg-row{
    display:grid;grid-template-columns:1fr repeat(4,110px) 90px 180px;
    gap:.4rem;align-items:center;
    padding:.6rem .9rem;border-bottom:1px solid var(--border);
    transition:background .15s;
  }
  .seg-row:hover{background:var(--paper);}
  .seg-row:last-child{border-bottom:none;}
  .seg-alumno-cell{display:flex;align-items:center;gap:.5rem;font-size:.86rem;font-weight:500;}

  /* botones de estado del indicador */
  .ind-toggle{
    display:flex;gap:.25rem;justify-content:center;
  }
  .ind-btn{
    width:32px;height:32px;border-radius:7px;border:2px solid var(--border);
    background:white;cursor:pointer;font-size:.85rem;font-weight:700;
    transition:all .15s;display:flex;align-items:center;justify-content:center;
    flex-shrink:0;
  }
  .ind-btn:hover{transform:scale(1.12);}
  .ind-btn.sel-ok{background:var(--sage);border-color:var(--sage);color:white;}
  .ind-btn.sel-no{background:var(--accent);border-color:var(--accent);color:white;}
  .ind-btn.sel-ep{background:var(--gold);border-color:var(--gold);color:var(--ink);}

  /* chip resumen */
  .seg-chip{
    font-size:.7rem;font-weight:700;padding:.2rem .5rem;
    border-radius:8px;white-space:nowrap;text-align:center;
  }
  .chip-full{background:rgba(74,124,89,.15);color:var(--sage);}
  .chip-part{background:rgba(212,160,23,.15);color:#9a7000;}
  .chip-none{background:rgba(192,57,43,.12);color:var(--accent);}

  /* leyenda */
  .seg-legend{display:flex;gap:1rem;font-size:.76rem;margin-bottom:.9rem;flex-wrap:wrap;align-items:center;}
  .seg-legend-item{display:flex;align-items:center;gap:.4rem;}
  .sl-dot{width:12px;height:12px;border-radius:4px;display:inline-block;}
  .sl-ok{background:var(--sage);}
  .sl-no{background:var(--accent);}
  .sl-ep{background:var(--gold);}
  .sl-nd{background:var(--border);}

  /* header indicadores nombres */
  .ind-name{text-align:center;font-size:.68rem;}

  /* obs textarea mini */
  .obs-input{
    width:100%;font-size:.75rem;padding:.3rem .5rem;resize:none;
    border:1px solid var(--border);border-radius:6px;background:var(--paper);
    font-family:'DM Sans',sans-serif;color:var(--ink);min-height:36px;
  }
  .obs-input:focus{outline:2px solid var(--gold);}

  /* modal seguimiento detalle */
  .det-grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1rem;}
  .det-ind-card{border:1px solid var(--border);border-radius:10px;padding:.9rem;text-align:center;}
  .det-ind-name{font-size:.72rem;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--muted);margin-bottom:.6rem;}
  .det-btns{display:flex;gap:.4rem;justify-content:center;}
  .det-btn{padding:.4rem .7rem;border-radius:7px;border:2px solid var(--border);background:white;cursor:pointer;font-size:.8rem;font-weight:700;transition:all .15s;}
  .det-btn:hover{transform:scale(1.06);}
  .det-btn.sel-ok{background:var(--sage);border-color:var(--sage);color:white;}
  .det-btn.sel-no{background:var(--accent);border-color:var(--accent);color:white;}
  .det-btn.sel-ep{background:var(--gold);border-color:var(--gold);color:var(--ink);}

  .seg-date-tag{font-size:.7rem;color:var(--muted);background:var(--paper);border:1px solid var(--border);padding:.15rem .5rem;border-radius:6px;display:inline-block;}

  /* GRIDS RESPONSIVOS */
  .dos-col-grid{display:grid;grid-template-columns:1fr 1fr;gap:1.2rem;margin-bottom:1.2rem;}
  .cal-layout-grid{display:grid;grid-template-columns:1fr 340px;gap:1.2rem;align-items:start;}
  @media(max-width:780px){
    .dos-col-grid{grid-template-columns:1fr;}
    .cal-layout-grid{grid-template-columns:1fr;}
  }

  /* NOTAS */
  .notas-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(230px,1fr));gap:.85rem;}
  .nota-card{border-radius:12px;padding:1rem 1.1rem;position:relative;border:1px solid transparent;transition:box-shadow .2s;}
  .nota-card:hover{box-shadow:0 4px 16px rgba(0,0,0,.1);}
  .nota-card.nc-yellow{background:#fffde7;border-color:#f9e97e;}
  .nota-card.nc-blue{background:#e3f2fd;border-color:#90caf9;}
  .nota-card.nc-green{background:#e8f5e9;border-color:#a5d6a7;}
  .nota-card.nc-red{background:#fde8e8;border-color:#f5a5a5;}
  .nota-card-titulo{font-weight:700;font-size:.9rem;margin-bottom:.4rem;color:var(--ink);}
  .nota-card-cuerpo{font-size:.82rem;color:#444;white-space:pre-wrap;line-height:1.5;margin-bottom:.6rem;}
  .nota-card-meta{font-size:.7rem;color:var(--muted);display:flex;align-items:center;justify-content:space-between;}
  .nota-card-actions{display:flex;gap:.3rem;}

  .btn-sync{background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);color:rgba(255,255,255,.85);border-radius:8px;padding:.35rem .75rem;font-size:.78rem;font-weight:600;cursor:pointer;font-family:'DM Sans',sans-serif;transition:all .2s;display:flex;align-items:center;gap:.3rem;}
  .btn-sync:hover{background:rgba(255,255,255,.18);}
  /* GOOGLE DRIVE */
  .drive-bar{display:flex;align-items:center;gap:.5rem;padding:.3rem .7rem;border-radius:8px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.15);font-size:.76rem;}
  .drive-status-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;transition:background .3s;}
  .ds-off{background:#666;}
  .ds-ok{background:#4ade80;}
  .ds-syncing{background:#fbbf24;animation:pulse-dot 1s infinite;}
  .ds-error{background:#f87171;}
  @keyframes pulse-dot{0%,100%{opacity:1;}50%{opacity:.4;}}
  .drive-user{color:rgba(255,255,255,.7);font-size:.72rem;max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
  .btn-drive{background:rgba(66,133,244,.25);border:1px solid rgba(66,133,244,.5);color:white;border-radius:7px;padding:.32rem .7rem;font-size:.75rem;font-weight:600;cursor:pointer;font-family:'DM Sans',sans-serif;transition:all .2s;white-space:nowrap;}
  .btn-drive:hover{background:rgba(66,133,244,.4);}
  .btn-drive.danger{background:rgba(239,68,68,.2);border-color:rgba(239,68,68,.4);}
  .drive-last{font-size:.68rem;color:rgba(255,255,255,.4);}
  /* SETUP MODAL */
  .setup-step{display:flex;gap:.8rem;padding:.8rem;border-radius:10px;background:var(--paper);border:1px solid var(--border);margin-bottom:.6rem;}
  .setup-num{width:24px;height:24px;border-radius:50%;background:var(--ink);color:var(--paper);display:flex;align-items:center;justify-content:center;font-size:.72rem;font-weight:700;flex-shrink:0;}
  .setup-text{font-size:.84rem;line-height:1.5;}
  .setup-text strong{display:block;margin-bottom:.2rem;}
  @media(max-width:480px){.sync-label{display:none;}.btn-sync{padding:.35rem .5rem;font-size:.85rem;}}

  /* ‚îÄ‚îÄ‚îÄ MEN√ö M√ÅS (mobile) ‚îÄ‚îÄ‚îÄ */
  .mas-overlay{display:none;position:fixed;inset:0;z-index:299;}
  .mas-menu{
    display:none;position:fixed;bottom:4.8rem;right:.75rem;
    background:var(--card);border:1px solid var(--border);
    border-radius:14px;box-shadow:0 8px 30px rgba(0,0,0,.22);
    z-index:300;min-width:185px;overflow:hidden;
    animation:fadeIn .18s ease;
  }
  .mas-menu.open,.mas-overlay.open{display:block;}
  .mas-item{
    padding:.9rem 1.2rem;font-size:.92rem;font-weight:600;
    cursor:pointer;border-bottom:1px solid var(--border);
    transition:background .15s;display:flex;align-items:center;gap:.6rem;
  }
  .mas-item:last-child{border-bottom:none;}
  .mas-item:active{background:var(--paper);}
  #bnav-mas.active-mas{color:var(--gold);}

  .bottom-nav{display:none;}
  @media(max-width:480px){
    .nav-tabs{display:none;}
    .bottom-nav{
      display:flex;position:fixed;bottom:0;left:0;right:0;
      background:var(--ink);border-top:2px solid var(--gold);
      z-index:200;padding-bottom:env(safe-area-inset-bottom);
    }
    .bnav-btn{
      flex:1;display:flex;flex-direction:column;align-items:center;
      padding:.5rem .2rem .4rem;font-size:.58rem;font-weight:600;
      color:rgba(255,255,255,.45);cursor:pointer;gap:.2rem;
      transition:color .2s;border:none;background:none;
    }
    .bnav-btn .bnav-icon{font-size:1.2rem;line-height:1;}
    .bnav-btn.active{color:var(--gold);}
    .bnav-btn:active{opacity:.7;}
    main{padding-bottom:5rem;}
  }
  @media(max-width:780px){
    main{padding:1rem;}
    #inicio-grid{grid-template-columns:1fr !important;}
    #cal-layout{grid-template-columns:1fr !important;}
    .seg-indicador-header,.seg-row{grid-template-columns:1fr repeat(2,90px) 80px;}
    .hide-mobile{display:none !important;}
    .notas-grid{grid-template-columns:1fr;}
  }

  /* ‚îÄ‚îÄ‚îÄ MOBILE (‚â§480px) ‚îÄ‚îÄ‚îÄ */
  @media(max-width:480px){
    header{padding:.7rem 1rem;}
    .logo{font-size:1.1rem;}
    .date-badge{font-size:.7rem;padding:.25rem .6rem;}
    .nav-tabs{padding:0 .5rem;}
    .nav-tab{padding:.6rem .65rem;font-size:.73rem;}
    main{padding:.75rem;}
    .stats-row{grid-template-columns:1fr 1fr;gap:.6rem;}
    .stat-value{font-size:1.5rem;}
    .stat-card{padding:.85rem 1rem;}
    #inicio-grid{grid-template-columns:1fr !important;}
    .form-grid{grid-template-columns:1fr;}
    .asist-row{flex-wrap:wrap;gap:.5rem;}
    .asist-nombre{width:100%;font-size:.9rem;}
    .asist-btns{justify-content:flex-start;}
    #historial-wrap .card{overflow-x:auto;}
    .seg-indicador-header{display:none;}
    .seg-row{
      display:flex;flex-direction:column;gap:.6rem;
      padding:.9rem 1rem;border-radius:12px;
      border:1px solid var(--border);margin-bottom:.6rem;
      background:var(--card);
    }
    .seg-row:hover{border-color:var(--gold);background:var(--card);}
    .seg-alumno-cell{font-size:.95rem;font-weight:600;}
    .ind-toggle{justify-content:flex-start;}
    .ind-label-mobile{display:block !important;}
    .ind-btn{width:40px;height:40px;font-size:.9rem;}
    .card{padding:1rem;}
    .card-title{font-size:.92rem;}
    .modal{width:97%;padding:1.3rem;max-height:94vh;}
    .btn{font-size:.8rem;}
    .school-pill{font-size:.74rem;padding:.35rem .75rem;}
    #tabla-alumnos-wrap{overflow-x:auto;}
    .notas-grid{grid-template-columns:1fr;}
    .cal-cell{min-height:40px;padding:.2rem .2rem;}
    .cal-num{font-size:.68rem;}
    .cal-event-dot{font-size:.52rem;padding:.05rem .2rem;}
    .escuela-card{flex-wrap:wrap;}
    .esc-actions{width:100%;justify-content:flex-end;margin-top:.3rem;}
  }
</style>
</head>
<body>

<header>
  <div class="logo">Profe<span>Desk</span></div>
  <div style="display:flex;align-items:center;gap:.5rem;flex-wrap:wrap;">
    <!-- Drive status bar -->
    <div class="drive-bar" id="drive-bar" title="Google Drive Sync">
      <div class="drive-status-dot ds-off" id="drive-dot"></div>
      <span class="drive-user" id="drive-user">Sin conectar</span>
      <span class="drive-last" id="drive-last"></span>
    </div>
    <button class="btn-drive" id="btn-drive-login" onclick="driveLogin()">üîó Conectar Drive</button>
    <button class="btn-drive" id="btn-drive-sync" onclick="driveSync()" style="display:none;">‚òÅÔ∏è <span class="sync-label">Sincronizar</span></button>
    <button class="btn-drive danger" id="btn-drive-logout" onclick="driveLogout()" style="display:none;" title="Desconectar Drive">‚úï</button>
    <button class="btn-sync" onclick="exportarDatos()" title="Exportar backup local">‚¨áÔ∏è <span class="sync-label">Backup</span></button>
    <button class="btn-sync" onclick="document.getElementById('import-input').click()" title="Importar datos">‚¨ÜÔ∏è <span class="sync-label">Importar</span></button>
    <input type="file" id="import-input" accept=".json" style="display:none" onchange="importarDatos(event)">
    <div class="date-badge" id="fecha-live"></div>
    <button class="btn-sync" onclick="openModal('drive-setup')" title="Configurar Drive" style="font-size:.85rem;">‚öôÔ∏è</button>
  </div>
</header>

<div class="nav-tabs">
  <div class="nav-tab active"   onclick="goTab('inicio',this)">üè† Inicio</div>
  <div class="nav-tab"          onclick="goTab('calendario',this)">üìÖ Calendario</div>
  <div class="nav-tab"          onclick="goTab('alumnos',this)">üë• Alumnos</div>
  <div class="nav-tab"          onclick="goTab('asistencia',this)">‚úÖ Asistencia</div>
  <div class="nav-tab"          onclick="goTab('historial',this)">üìä Historial</div>
  <div class="nav-tab"          onclick="goTab('seguimiento',this)">üéØ Seguimiento</div>
  <div class="nav-tab"          onclick="goTab('horario',this)">üïê Horario</div>
  <div class="nav-tab"          onclick="goTab('escuelas',this)">üè´ Escuelas</div>
</div>

<!-- Navegaci√≥n inferior para mobile -->
<nav class="bottom-nav" id="bottom-nav">
  <button class="bnav-btn active" onclick="bnavGo('inicio',0)"><span class="bnav-icon">üè†</span>Inicio</button>
  <button class="bnav-btn" onclick="bnavGo('asistencia',1)"><span class="bnav-icon">‚úÖ</span>Asistencia</button>
  <button class="bnav-btn" onclick="bnavGo('alumnos',2)"><span class="bnav-icon">üë•</span>Alumnos</button>
  <button class="bnav-btn" onclick="bnavGo('seguimiento',3)"><span class="bnav-icon">üéØ</span>Seguimiento</button>
  <button class="bnav-btn" onclick="toggleMasMenu()" id="bnav-mas"><span class="bnav-icon">‚ò∞</span>M√°s</button>
</nav>

<!-- Men√∫ "M√°s" desplegable -->
<div class="mas-menu" id="mas-menu">
  <div class="mas-item" onclick="bnavGoMas('calendario')">üìÖ Calendario</div>
  <div class="mas-item" onclick="bnavGoMas('historial')">üìä Historial</div>
  <div class="mas-item" onclick="bnavGoMas('horario')">üïê Horario</div>
  <div class="mas-item" onclick="bnavGoMas('escuelas')">üè´ Escuelas</div>
</div>
<div class="mas-overlay" id="mas-overlay" onclick="closeMasMenu()"></div>

<main>

<!-- ‚ïê‚ïê‚ïê INICIO ‚ïê‚ïê‚ïê -->
<div class="tab-content active" id="tab-inicio">
  <div class="stats-row" id="stats-row"></div>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:1.2rem;margin-bottom:1.2rem;" id="inicio-grid" class="dos-col-grid">
    <div class="card" style="margin:0;"><div class="card-title">Resumen por escuela</div><div id="resumen-escuelas"></div></div>
    <div class="card" style="margin:0;">
      <div class="card-title">
        üìÖ Pr√≥ximos eventos
        <button class="btn btn-ghost btn-sm" onclick="goTabDirect('calendario')">Ver calendario</button>
      </div>
      <div id="proximos-inicio"></div>
    </div>
  </div>

  <!-- NOTAS / BLOC DEL PROFE -->
  <div class="card">
    <div class="card-title">
      üìù Mis notas
      <button class="btn btn-primary btn-sm" onclick="openModalNota()">+ Nueva nota</button>
    </div>
    <div id="notas-lista-inicio"></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê CALENDARIO ‚ïê‚ïê‚ïê -->
<div class="tab-content" id="tab-calendario">
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem;flex-wrap:wrap;gap:.5rem;">
    <div class="section-title" style="margin:0;">Calendario escolar</div>
    <button class="btn btn-primary" onclick="openModal('evento')">+ Nuevo evento</button>
  </div>

  <div style="display:grid;grid-template-columns:1fr 340px;gap:1.2rem;align-items:start;" id="cal-layout" class="cal-layout-grid">
    <!-- Calendario visual -->
    <div class="card" style="margin:0;">
      <div class="cal-nav">
        <button class="cal-nav-btn" onclick="calPrev()">‚óÄ</button>
        <div class="cal-month-label" id="cal-mes-label"></div>
        <button class="cal-nav-btn" onclick="calNext()">‚ñ∂</button>
      </div>
      <div class="cal-grid" id="cal-grid"></div>
    </div>

    <!-- Lista de eventos -->
    <div>
      <div class="card" style="margin:0;">
        <div class="card-title">
          Eventos
          <div style="display:flex;gap:.4rem;flex-wrap:wrap;">
            <span style="font-size:.7rem;display:flex;align-items:center;gap:.3rem;"><span style="width:8px;height:8px;border-radius:50%;background:var(--accent);display:inline-block;"></span>Examen</span>
            <span style="font-size:.7rem;display:flex;align-items:center;gap:.3rem;"><span style="width:8px;height:8px;border-radius:50%;background:var(--sage);display:inline-block;"></span>Notas</span>
            <span style="font-size:.7rem;display:flex;align-items:center;gap:.3rem;"><span style="width:8px;height:8px;border-radius:50%;background:var(--gold);display:inline-block;"></span>Evento</span>
            <span style="font-size:.7rem;display:flex;align-items:center;gap:.3rem;"><span style="width:8px;height:8px;border-radius:50%;background:#7d3c98;display:inline-block;"></span>Feriado</span>
            <span style="font-size:.7rem;display:flex;align-items:center;gap:.3rem;"><span style="width:8px;height:8px;border-radius:50%;background:#2471a3;display:inline-block;"></span>Jornada</span>
            <span style="font-size:.7rem;display:flex;align-items:center;gap:.3rem;"><span style="width:8px;height:8px;border-radius:50%;background:#16a085;display:inline-block;"></span>Acto</span>
          </div>
        </div>
        <div id="lista-eventos"></div>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê ALUMNOS ‚ïê‚ïê‚ïê -->
<div class="tab-content" id="tab-alumnos">
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem;flex-wrap:wrap;gap:.5rem;">
    <div class="section-title" style="margin:0;">Mis alumnos</div>
    <div style="display:flex;gap:.5rem;flex-wrap:wrap;">
      <button class="btn btn-ghost" onclick="descargarPlantilla()">üìÑ Plantilla CSV</button>
      <button class="btn btn-ghost" onclick="document.getElementById('import-alumnos-input').click()">üì• Importar CSV/Excel</button>
      <input type="file" id="import-alumnos-input" accept=".csv,.xlsx,.xls" style="display:none" onchange="importarAlumnos(event)">
      <button class="btn btn-primary" onclick="openModal('alumno')">+ Nuevo alumno</button>
    </div>
  </div>
  <div class="school-bar" id="filtro-alumnos-pills"></div>
  <div class="search-wrap">
    <span class="search-icon">üîç</span>
    <input type="text" placeholder="Buscar por nombre‚Ä¶" id="search-alumno" oninput="renderTablaAlumnos()">
  </div>
  <div class="card" style="padding:0;overflow:hidden;"><div id="tabla-alumnos-wrap"></div></div>
</div>

<!-- ‚ïê‚ïê‚ïê ASISTENCIA ‚ïê‚ïê‚ïê -->
<div class="tab-content" id="tab-asistencia">
  <div class="section-title">Tomar asistencia</div>
  <div class="school-bar" id="filtro-asist-pills"></div>
  <div class="card" style="margin-bottom:1rem;">
    <div style="display:flex;gap:1rem;align-items:flex-end;flex-wrap:wrap;">
      <div style="flex:1;min-width:130px;"><label>Fecha</label><input type="date" id="asist-fecha" onchange="renderAsistLista();cargarTema()"></div>
      <div style="flex:1;min-width:130px;"><label>Curso</label><select id="asist-curso" onchange="updateMateriasAsist();renderAsistLista();cargarTema()"></select></div>
      <div style="flex:1;min-width:130px;"><label>Materia</label><select id="asist-materia" onchange="renderAsistLista();cargarTema()"></select></div>
      <div style="display:flex;gap:.5rem;flex-wrap:wrap;">
        <button class="btn btn-success" onclick="guardarAsistencia()">üíæ Guardar</button>
        <button class="btn btn-ghost" onclick="exportarCSV()">‚¨áÔ∏è Exportar CSV</button>
      </div>
    </div>
    <hr style="border:none;border-top:1px solid var(--border);margin:.9rem 0;">
    <div style="display:flex;gap:.8rem;flex-wrap:wrap;">
      <div style="flex:2;min-width:180px;"><label>üìñ Tema de la clase</label><input type="text" id="asist-tema-titulo" placeholder="Ej: Oferta y demanda" oninput="guardarTemaAuto()"></div>
      <div style="flex:3;min-width:200px;"><label>üéØ Objetivos / descripci√≥n</label><input type="text" id="asist-tema-desc" placeholder="Ej: Comprender el equilibrio de mercado‚Ä¶" oninput="guardarTemaAuto()"></div>
    </div>
  </div>
  <div id="asist-summary-bar" class="asist-summary"></div>
  <div class="asist-list" id="asist-lista"></div>
  <div class="empty-state" id="asist-empty"><div class="big">üìã</div><div>Seleccion√° una escuela, curso y materia</div></div>
</div>

<!-- ‚ïê‚ïê‚ïê HISTORIAL ‚ïê‚ïê‚ïê -->
<div class="tab-content" id="tab-historial">
  <div class="section-title">Historial de asistencia</div>
  <div class="school-bar" id="filtro-hist-pills"></div>
  <div style="display:flex;gap:.8rem;align-items:flex-end;flex-wrap:wrap;margin-bottom:1rem;">
    <div style="flex:1;min-width:130px;"><label>Curso</label><select id="hist-curso" onchange="updateMateriasHist();renderHistorial()"></select></div>
    <div style="flex:1;min-width:130px;"><label>Materia</label><select id="hist-materia" onchange="renderHistorial()"></select></div>
    <button class="btn btn-ghost" onclick="exportarCSVHistorial()">‚¨áÔ∏è Exportar CSV completo</button>
  </div>
  <div id="historial-wrap"></div>
</div>

<!-- ‚ïê‚ïê‚ïê SEGUIMIENTO ‚ïê‚ïê‚ïê -->
<div class="tab-content" id="tab-seguimiento">
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem;flex-wrap:wrap;gap:.5rem;">
    <div class="section-title" style="margin:0;">Seguimiento pedag√≥gico</div>
    <button class="btn btn-ghost" onclick="exportarCSVSeguimiento()">‚¨áÔ∏è Exportar CSV</button>
  </div>
  <div class="school-bar" id="filtro-seg-pills"></div>
  <div style="display:flex;gap:.8rem;align-items:flex-end;flex-wrap:wrap;margin-bottom:.8rem;">
    <div style="flex:1;min-width:130px;"><label>Curso</label><select id="seg-curso" onchange="updateMateriasSeg();renderSeguimiento()"></select></div>
    <div style="flex:1;min-width:130px;"><label>Materia</label><select id="seg-materia" onchange="renderSeguimiento();cargarTemaSeg()"></select></div>
    <div style="flex:1;min-width:130px;"><label>Fecha de registro</label><input type="date" id="seg-fecha" onchange="renderSeguimiento();cargarTemaSeg()"></div>
  </div>
  <div class="card" style="margin-bottom:1rem;padding:1rem 1.2rem;">
    <div style="display:flex;gap:.8rem;flex-wrap:wrap;">
      <div style="flex:2;min-width:180px;"><label>üìñ Tema de la clase</label><input type="text" id="seg-tema-titulo" placeholder="Ej: Oferta y demanda" oninput="guardarTemaSegAuto()"></div>
      <div style="flex:3;min-width:200px;"><label>üéØ Objetivos / descripci√≥n</label><input type="text" id="seg-tema-desc" placeholder="Ej: Comprender el equilibrio de mercado‚Ä¶" oninput="guardarTemaSegAuto()"></div>
    </div>
  </div>

  <div class="seg-legend">
    <span class="seg-legend-item"><span class="sl-dot sl-ok"></span>‚úì Logrado</span>
    <span class="seg-legend-item"><span class="sl-dot sl-ep"></span>~ En proceso</span>
    <span class="seg-legend-item"><span class="sl-dot sl-no"></span>‚úó No logrado</span>
    <span class="seg-legend-item"><span class="sl-dot sl-nd"></span>Sin registro</span>
    <span style="color:var(--muted);font-size:.74rem;margin-left:auto;">Clic en los botones para registrar ¬∑ Clic en el nombre para ver detalle</span>
  </div>

  <div class="card" style="padding:0;overflow:hidden;">
    <div class="seg-indicador-header">
      <div>Alumno</div>
      <div class="ind-name">üß† INTERPRETA</div>
      <div class="ind-name">üîç ANALIZA</div>
      <div class="ind-name hide-mobile">‚öôÔ∏è RESUELVE</div>
      <div class="ind-name hide-mobile">üí¨ TRANSMITE</div>
      <div class="ind-name">Resumen</div>
      <div class="ind-name hide-mobile">üìù Observaci√≥n</div>
    </div>
    <div id="seg-lista"></div>
  </div>

  <div class="empty-state" id="seg-empty" style="display:none;">
    <div class="big">üéØ</div>
    <div>Seleccion√° una escuela y curso para ver el seguimiento</div>
  </div>
</div>


<!-- ‚ïê‚ïê‚ïê HORARIO ‚ïê‚ïê‚ïê -->
<div class="tab-content" id="tab-horario">
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem;flex-wrap:wrap;gap:.5rem;">
    <div class="section-title" style="margin:0;">Mi horario semanal</div>
    <button class="btn btn-primary" onclick="openModal('clase')">+ Agregar clase</button>
  </div>

  <div class="horario-vista-btns">
    <button class="vista-btn active" id="btn-vista-semana" onclick="setVistaHorario('semana')">üìÖ Vista semanal</button>
    <button class="vista-btn" id="btn-vista-dia" onclick="setVistaHorario('dia')">üìã Vista por d√≠a</button>
  </div>

  <!-- VISTA SEMANAL -->
  <div id="horario-semana">
    <div class="card" style="padding:.8rem;overflow-x:auto;">
      <div class="horario-grid" id="horario-grid"></div>
    </div>
  </div>

  <!-- VISTA D√çA -->
  <div id="horario-dia" style="display:none;">
    <div class="dia-nav">
      <button class="dia-nav-btn" onclick="diaNav(-1)">‚óÄ</button>
      <div class="dia-nombre" id="dia-nombre-label"></div>
      <button class="dia-nav-btn" onclick="diaNav(1)">‚ñ∂</button>
    </div>
    <div id="horario-dia-content"></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê ESCUELAS ‚ïê‚ïê‚ïê -->
<div class="tab-content" id="tab-escuelas">
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem;">
    <div class="section-title" style="margin:0;">Mis escuelas</div>
    <button class="btn btn-primary" onclick="openModal('escuela')">+ Nueva escuela</button>
  </div>
  <div id="lista-escuelas"></div>
  <hr class="divider">
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:.8rem;">
    <div style="font-family:'Playfair Display',serif;font-size:1.1rem;">Cursos</div>
    <button class="btn btn-primary btn-sm" onclick="openModal('curso')">+ Nuevo curso</button>
  </div>
  <div id="lista-cursos"></div>
  <hr class="divider">
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:.8rem;">
    <div style="font-family:'Playfair Display',serif;font-size:1.1rem;">Materias</div>
    <button class="btn btn-primary btn-sm" onclick="openModal('materia')">+ Nueva materia</button>
  </div>
  <div id="lista-materias"></div>
</div>

</main>

<!-- MODALS -->
<div class="modal-bg" id="modal-alumno">
  <div class="modal">
    <div class="modal-title" id="modal-alumno-title">Nuevo alumno</div>
    <input type="hidden" id="edit-alumno-id">
    <div class="form-row"><label>Nombre completo</label><input id="al-nombre" placeholder="Ej: Garc√≠a, Luc√≠a"></div>
    <div class="form-grid">
      <div class="form-row"><label>Escuela</label><select id="al-escuela" onchange="updateCursosSelect('al-escuela','al-curso');renderNotasAlumnoModal()"></select></div>
      <div class="form-row"><label>Curso</label><select id="al-curso" onchange="renderNotasAlumnoModal()"></select></div>
    </div>
    <div id="al-notas-por-materia"></div>
    <div class="form-actions">
      <button class="btn btn-ghost" onclick="closeModal('alumno')">Cancelar</button>
      <button class="btn btn-primary" onclick="saveAlumno()">Guardar</button>
    </div>
  </div>
</div>

<div class="modal-bg" id="modal-escuela">
  <div class="modal">
    <div class="modal-title" id="modal-escuela-title">Nueva escuela</div>
    <input type="hidden" id="edit-escuela-id">
    <div class="form-row"><label>Nombre de la escuela</label><input id="esc-nombre" placeholder="Ej: Escuela San Mart√≠n"></div>
    <div class="form-row"><label>Direcci√≥n (opcional)</label><input id="esc-dir" placeholder="Ej: Av. Belgrano 123"></div>
    <div class="form-actions">
      <button class="btn btn-ghost" onclick="closeModal('escuela')">Cancelar</button>
      <button class="btn btn-primary" onclick="saveEscuela()">Guardar</button>
    </div>
  </div>
</div>

<div class="modal-bg" id="modal-curso">
  <div class="modal">
    <div class="modal-title" id="modal-curso-title">Nuevo curso</div>
    <input type="hidden" id="edit-curso-id">
    <div class="form-row"><label>Nombre del curso</label><input id="cur-nombre" placeholder="Ej: 3¬∞B"></div>
    <div class="form-row"><label>Escuela</label><select id="cur-escuela"></select></div>
    <div class="form-grid">
      <div class="form-row"><label>Preceptor/a</label><input id="cur-preceptor" placeholder="Ej: Mart√≠nez, Ana"></div>
      <div class="form-row"><label>Tutor/a</label><input id="cur-tutor" placeholder="Ej: L√≥pez, Carlos"></div>
    </div>
    <div class="form-row">
      <label>Materias asignadas</label>
      <div id="cur-materias-checks" style="display:flex;flex-wrap:wrap;gap:.5rem;margin-top:.3rem;"></div>
    </div>
    <div class="form-actions">
      <button class="btn btn-ghost" onclick="closeModal('curso')">Cancelar</button>
      <button class="btn btn-primary" onclick="saveCurso()">Guardar</button>
    </div>
  </div>
</div>

<div class="modal-bg" id="modal-materia">
  <div class="modal">
    <div class="modal-title" id="modal-materia-title">Nueva materia</div>
    <input type="hidden" id="edit-materia-id">
    <div class="form-row"><label>Nombre de la materia</label><input id="mat-nombre" placeholder="Ej: Econom√≠a, Contabilidad‚Ä¶"></div>
    <div class="form-actions">
      <button class="btn btn-ghost" onclick="closeModal('materia')">Cancelar</button>
      <button class="btn btn-primary" onclick="saveMateria()">Guardar</button>
    </div>
  </div>
</div>

<!-- Modal detalle seguimiento alumno -->
<div class="modal-bg" id="modal-seguimiento">
  <div class="modal">
    <div class="modal-title" id="seg-modal-title">Seguimiento de alumno</div>
    <input type="hidden" id="seg-modal-alumno-id">
    <div id="seg-modal-content"></div>
    <div class="form-actions">
      <button class="btn btn-ghost" onclick="closeModal('seguimiento')">Cerrar</button>
      <button class="btn btn-success" onclick="guardarDetalleSeg()">üíæ Guardar</button>
    </div>
  </div>
</div>

<!-- NOTIFICACI√ìN AL ABRIR -->
<div class="notif-overlay" id="notif-overlay">
  <div class="notif-box">
    <div class="notif-header">
      <span class="notif-icon">üîî</span>
      <div>
        <div class="notif-title">Recordatorios del d√≠a</div>
        <div style="font-size:.76rem;color:var(--muted);" id="notif-fecha-hoy"></div>
      </div>
    </div>
    <div id="notif-lista"></div>
    <div style="display:flex;justify-content:flex-end;margin-top:1rem;">
      <button class="btn btn-primary" onclick="cerrarNotif()">Entendido ‚úì</button>
    </div>
  </div>
</div>

<!-- MODAL EVENTO -->
<div class="modal-bg" id="modal-evento">
  <div class="modal">
    <div class="modal-title" id="modal-evento-title">Nuevo evento</div>
    <input type="hidden" id="edit-evento-id">
    <div class="form-row"><label>T√≠tulo del evento</label><input id="ev-titulo" placeholder="Ej: Parcial de Econom√≠a 3¬∞B"></div>
    <div class="form-grid">
      <div class="form-row">
        <label>Tipo</label>
        <select id="ev-tipo">
          <option value="examen">üìù Examen / Parcial</option>
          <option value="notas">üìã Entrega de notas</option>
          <option value="evento">üìå Evento general</option>
          <option value="feriado">üèñÔ∏è Feriado</option>
          <option value="jornada">üè´ Jornada institucional</option>
          <option value="acto">üé≠ Acto escolar</option>
        </select>
      </div>
      <div class="form-row"><label>Fecha</label><input type="date" id="ev-fecha"></div>
    </div>
    <div class="form-row"><label>Escuela (opcional)</label>
      <select id="ev-escuela">
        <option value="">Todas las escuelas</option>
      </select>
    </div>
    <div class="form-row"><label>Notas / descripci√≥n</label><textarea id="ev-obs" rows="2" placeholder="Detalles adicionales‚Ä¶"></textarea></div>
    <div class="form-actions">
      <button class="btn btn-ghost" onclick="closeModal('evento')">Cancelar</button>
      <button class="btn btn-primary" onclick="saveEvento()">Guardar</button>
    </div>
  </div>
</div>

<!-- MODAL NOTA -->
<div class="modal-bg" id="modal-nota">
  <div class="modal">
    <div class="modal-title" id="modal-nota-title">Nueva nota</div>
    <input type="hidden" id="edit-nota-id">
    <div class="form-row"><label>T√≠tulo</label><input id="nota-titulo" placeholder="Ej: Recordatorio, idea, tarea‚Ä¶"></div>
    <div class="form-row"><label>Contenido</label><textarea id="nota-cuerpo" rows="5" placeholder="Escrib√≠ tu nota ac√°‚Ä¶"></textarea></div>
    <div class="form-grid">
      <div class="form-row">
        <label>Color / categor√≠a</label>
        <select id="nota-color">
          <option value="yellow">üü° Amarillo (general)</option>
          <option value="blue">üîµ Azul (pendiente)</option>
          <option value="green">üü¢ Verde (resuelto)</option>
          <option value="red">üî¥ Rojo (urgente)</option>
        </select>
      </div>
      <div class="form-row"><label>Escuela (opcional)</label><select id="nota-escuela"><option value="">Todas</option></select></div>
    </div>
    <div class="form-actions">
      <button class="btn btn-ghost" onclick="closeModal('nota')">Cancelar</button>
      <button class="btn btn-primary" onclick="saveNota()">Guardar</button>
    </div>
  </div>
</div>

<!-- MODAL IMPORTAR ALUMNOS -->
<div class="modal-bg" id="modal-import-alumnos">
  <div class="modal" style="max-width:640px;">
    <div class="modal-title">üì• Importar alumnos</div>
    <div id="import-preview-info" style="font-size:.83rem;color:var(--muted);margin-bottom:.8rem;"></div>
    <div id="import-preview-wrap" style="max-height:300px;overflow-y:auto;margin-bottom:1rem;"></div>
    <div id="import-errores" style="display:none;background:rgba(192,57,43,.07);border:1px solid rgba(192,57,43,.25);border-radius:8px;padding:.8rem;margin-bottom:.8rem;font-size:.8rem;color:var(--accent);"></div>
    <div class="form-actions">
      <button class="btn btn-ghost" onclick="closeModal('import-alumnos')">Cancelar</button>
      <button class="btn btn-success" id="btn-confirmar-import" onclick="confirmarImportAlumnos()">‚úÖ Importar todos</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ESTADO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const COLORS=['#c0392b','#4a7c59','#d4a017','#2471a3','#7d3c98'];
const CNAMES=['s1','s2','s3','s4','s5'];
const TIPO_COLOR={examen:'var(--accent)',notas:'var(--sage)',evento:'var(--gold)',feriado:'#7d3c98',jornada:'#2471a3',acto:'#16a085'};
const TIPO_CLASS={examen:'cev-examen',notas:'cev-notas',evento:'cev-evento',feriado:'cev-feriado',jornada:'cev-jornada',acto:'cev-acto'};
const TIPO_LABEL={examen:'üìù Examen',notas:'üìã Entrega notas',evento:'üìå Evento',feriado:'üèñÔ∏è Feriado',jornada:'üè´ Jornada institucional',acto:'üé≠ Acto escolar'};
let calView={year:new Date().getFullYear(),month:new Date().getMonth()};

let state={
  escuelas:[
    {id:1,nombre:'Escuela San Mart√≠n',dir:'Av. San Mart√≠n 400'},
    {id:2,nombre:'Instituto Belgrano',dir:'Calle Belgrano 150'},
    {id:3,nombre:'Colegio del Norte',dir:'Ruta 22 km 5'}
  ],
  materias:[
    {id:1,nombre:'Econom√≠a'},
    {id:2,nombre:'Contabilidad'},
  ],
  // cursoMaterias: qu√© materias tiene cada curso
  // cursoMaterias[cursoId] = [materiaId, ...]
  cursoMaterias:{1:[1,2],2:[1],3:[2],4:[1,2]},
  cursos:[
    {id:1,nombre:'3¬∞B',escuelaId:1},
    {id:2,nombre:'1¬∞A',escuelaId:2},
    {id:3,nombre:'2¬∞A',escuelaId:2},
    {id:4,nombre:'4¬∞C',escuelaId:3}
  ],
  alumnos:[
    {id:1,nombre:'Garc√≠a, Luc√≠a',    cursoId:1,notas:{}},
    {id:2,nombre:'Mart√≠nez, Rodrigo',cursoId:1,notas:{}},
    {id:3,nombre:'Fern√°ndez, Sof√≠a', cursoId:1,notas:{}},
    {id:4,nombre:'L√≥pez, Tom√°s',     cursoId:1,notas:{}},
    {id:5,nombre:'√Ålvarez, Giuliana',cursoId:2,notas:{}},
    {id:6,nombre:'Ben√≠tez, Ramiro',  cursoId:2,notas:{}},
    {id:7,nombre:'Sosa, Valentina',  cursoId:3,notas:{}},
    {id:8,nombre:'Romero, Diego',    cursoId:4,notas:{}}
  ],
  // temas[`${cursoId}_${materiaId}_${fecha}`] = { titulo, descripcion }
  temas:{},
  // asistencia[`${cursoId}_${materiaId}_${fecha}`] = { alumnoId: { estado, nota } }
  asistencia:{},
  nextId:100,
  filtroEscuelaAlumnos:0,
  filtroEscuelaAsist:null,
  filtroEscuelaHist:null,
  filtroEscuelaSeg:null,
  asistTemp:{},
  // seguimiento[alumnoId][materiaId][fecha] = { interpreta, analiza, resuelve, transmite, obs }
  seguimiento:{},
  // horario
  horario:[],
  // trayectoria[alumnoId] = {situacion,anioIngreso,escuelaOrigen,condicion,contexto,observaciones,obsActualizada,intervenciones:[]}
  trayectoria:{},
  eventos:[],
  notas:[],
};

// Seed eventos demo
(function seedEventos(){
  const today=new Date();
  const add=(n)=>{const d=new Date(today);d.setDate(d.getDate()+n);return d.toISOString().slice(0,10);};
  state.eventos=[
    {id:901,titulo:'Parcial de Econom√≠a 3¬∞B',tipo:'examen',fecha:add(3),escuelaId:1,obs:'Unidades 1 a 3'},
    {id:902,titulo:'Entrega notas 1¬∞ trimestre',tipo:'notas',fecha:add(7),escuelaId:null,obs:''},
    {id:903,titulo:'Acto escolar D√≠a del Maestro',tipo:'evento',fecha:add(12),escuelaId:2,obs:''},
    {id:904,titulo:'Parcial Intro Eco 1¬∞A',tipo:'examen',fecha:add(0),escuelaId:2,obs:'Tema: Sistemas econ√≥micos'},
    {id:905,titulo:'Cierre de notas bolet√≠n',tipo:'notas',fecha:add(21),escuelaId:null,obs:''},
  ];
})();

// Datos de ejemplo de asistencia para demo
(function seedAsistencia(){
  const today=new Date();
  const fmt=d=>d.toISOString().slice(0,10);
  const days=(n)=>{const d=new Date(today);d.setDate(d.getDate()-n);return fmt(d);};
  const set=(cursoId,materiaId,fecha,data)=>{state.asistencia[`${cursoId}_${materiaId}_${fecha}`]=data;};
  const c1alumnos=[1,2,3,4];
  for(let i=0;i<5;i++){
    const obj={};
    c1alumnos.forEach((aId)=>{obj[aId]={estado:['P','P','A'][i%3],nota:null};});
    obj[1]={estado:'P',nota:null};obj[2]={estado:'A',nota:null};
    set(1,1,days(i*2),obj);
  }
})();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getColor(escId){const i=state.escuelas.findIndex(e=>e.id===escId);return COLORS[i%COLORS.length]||'#888';}
function getCC(escId){const i=state.escuelas.findIndex(e=>e.id===escId);return CNAMES[i%CNAMES.length]||'s0';}
function getCurso(id){return state.cursos.find(c=>c.id===id);}
function getEscuela(id){return state.escuelas.find(e=>e.id===id);}
function getMateria(id){return state.materias.find(m=>m.id===id);}
function getMateriasDelCurso(cursoId){
  const ids=state.cursoMaterias[cursoId]||[];
  return ids.map(id=>state.materias.find(m=>m.id===id)).filter(Boolean);
}
function initials(n){return n.split(',').map(p=>p.trim()[0]||'').join('').toUpperCase().slice(0,2);}
function promedio(al,materiaId){
  if(!materiaId)return null;
  const n=al.notas&&al.notas[materiaId]||{};
  const v=[n.t1,n.t2,n.t3].filter(x=>x!=null);
  return v.length?(v.reduce((a,b)=>a+b,0)/v.length).toFixed(1):null;
}
function notaClass(n){if(n==null)return'';if(n>=7)return'nota-a';if(n>=5)return'nota-b';return'nota-c';}
function newId(){return++state.nextId;}
function showToast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2600);}
function fmtFecha(f){if(!f)return'';const[y,m,d]=f.split('-');return`${d}/${m}/${y}`;}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TABS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function goTab(name,el){
  document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t=>t.classList.remove('active'));
  document.getElementById('tab-'+name).classList.add('active');
  el.classList.add('active');
  renderAll();
  if(name==='horario')renderHorario();
}
function goTabDirect(name){
  const tabs=document.querySelectorAll('.nav-tab');
  const map={'inicio':0,'calendario':1,'alumnos':2,'asistencia':3,'historial':4,'seguimiento':5,'horario':6,'escuelas':7};
  goTab(name,tabs[map[name]]);
}
function bnavGo(name,idx){
  closeMasMenu();
  goTabDirect(name);
  document.querySelectorAll('.bnav-btn').forEach((b,i)=>b.classList.toggle('active',i===idx));
  document.getElementById('bnav-mas').classList.remove('active-mas');
}
function toggleMasMenu(){
  const menu=document.getElementById('mas-menu');
  const overlay=document.getElementById('mas-overlay');
  const btn=document.getElementById('bnav-mas');
  const isOpen=menu.classList.contains('open');
  if(isOpen){closeMasMenu();}
  else{menu.classList.add('open');overlay.classList.add('open');btn.classList.add('active-mas');}
}
function closeMasMenu(){
  document.getElementById('mas-menu').classList.remove('open');
  document.getElementById('mas-overlay').classList.remove('open');
  document.getElementById('bnav-mas').classList.remove('active-mas');
}
function bnavGoMas(name){
  closeMasMenu();
  goTabDirect(name);
  // quitar active de todos los bnav-btn normales
  document.querySelectorAll('.bnav-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('bnav-mas').classList.add('active');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INICIO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderInicio(){
  const promedios=state.alumnos.map(a=>parseFloat(promedio(a))).filter(v=>!isNaN(v));
  const pg=promedios.length?(promedios.reduce((a,b)=>a+b,0)/promedios.length).toFixed(1):'‚Äî';
  const totalAsist=Object.keys(state.asistencia).length;
  document.getElementById('stats-row').innerHTML=`
    <div class="stat-card red"><div class="stat-label">Alumnos</div><div class="stat-value">${state.alumnos.length}</div><div class="stat-sub">${state.escuelas.length} escuelas</div></div>
    <div class="stat-card green"><div class="stat-label">Cursos</div><div class="stat-value">${state.cursos.length}</div></div>
    <div class="stat-card gold"><div class="stat-label">Prom. general</div><div class="stat-value">${pg}</div></div>
    <div class="stat-card ink"><div class="stat-label">Registros asist.</div><div class="stat-value">${totalAsist}</div></div>
  `;
  const res=state.escuelas.map(e=>{
    const cs=state.cursos.filter(c=>c.escuelaId===e.id);
    const als=state.alumnos.filter(a=>cs.some(c=>c.id===a.cursoId));
    return`<div style="display:flex;align-items:center;gap:1rem;padding:.7rem 0;border-bottom:1px solid var(--border);">
      <div style="width:10px;height:10px;border-radius:50%;background:${getColor(e.id)};flex-shrink:0;"></div>
      <div style="flex:1;"><div style="font-weight:600;font-size:.9rem;">${e.nombre}</div>
      <div style="font-size:.74rem;color:var(--muted);">${cs.length} curso(s) ¬∑ ${als.length} alumno(s)</div></div>
    </div>`;
  }).join('');
  document.getElementById('resumen-escuelas').innerHTML=res||'<div style="color:var(--muted);font-size:.88rem;">Sin escuelas.</div>';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ALUMNOS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderFiltroAlumnos(){
  document.getElementById('filtro-alumnos-pills').innerHTML=
    `<div class="school-pill s0 ${!state.filtroEscuelaAlumnos?'active':''}" onclick="setFA(0)"><span class="dot"></span>Todas</div>`+
    state.escuelas.map(e=>`<div class="school-pill ${getCC(e.id)} ${state.filtroEscuelaAlumnos===e.id?'active':''}" onclick="setFA(${e.id})"><span class="dot"></span>${e.nombre}</div>`).join('');
}
function setFA(id){state.filtroEscuelaAlumnos=id;renderFiltroAlumnos();renderTablaAlumnos();}

function renderTablaAlumnos(){
  const q=(document.getElementById('search-alumno').value||'').toLowerCase();
  let als=state.alumnos;
  if(state.filtroEscuelaAlumnos){
    const ids=state.cursos.filter(c=>c.escuelaId===state.filtroEscuelaAlumnos).map(c=>c.id);
    als=als.filter(a=>ids.includes(a.cursoId));
  }
  if(q)als=als.filter(a=>a.nombre.toLowerCase().includes(q));
  const w=document.getElementById('tabla-alumnos-wrap');
  if(!als.length){w.innerHTML='<div class="empty-state"><div class="big">üë§</div><div>Sin alumnos.</div></div>';return;}
  w.innerHTML=`<table><thead><tr><th>Nombre</th><th>Escuela ¬∑ Curso</th><th>Materias</th><th>Asist.</th><th></th></tr></thead><tbody>
  ${als.map(al=>{
    const c=getCurso(al.cursoId),e=c?getEscuela(c.escuelaId):null,col=e?getColor(e.id):'#888';
    const mats=c?getMateriasDelCurso(c.id):[];
    const entries=Object.entries(state.asistencia).filter(([k])=>k.startsWith(c?c.id+'_':''));
    const pct=entries.length?Math.round(entries.filter(([,v])=>v[al.id]&&v[al.id].estado==='P').length/entries.length*100):'‚Äî';
    const matsHtml=mats.map(m=>{
      const n=al.notas&&al.notas[m.id]||{};
      const p=promedio(al,m.id);
      return`<div style="font-size:.75rem;margin-bottom:.15rem;">
        <span style="font-weight:600;">${m.nombre}:</span>
        ${['t1','t2','t3'].map(t=>n[t]!=null?`<span class="nota-badge ${notaClass(n[t])}">${n[t]}</span>`:'').join(' ')}
        ${p?`‚Üí <span class="nota-badge ${notaClass(parseFloat(p))}">${p}</span>`:''}
      </div>`;
    }).join('');
    return`<tr>
      <td><div class="alumno-link" style="display:flex;align-items:center;" onclick="abrirTrayectoria(${al.id})"><div class="avatar" style="background:${col}">${initials(al.nombre)}</div><span class="av-nombre">${al.nombre}</span></div></td>
      <td><span style="font-size:.76rem;font-weight:600;color:${col}">${e?e.nombre:'‚Äî'}</span> <span style="color:var(--muted);font-size:.76rem;">${c?c.nombre:''}</span></td>
      <td>${matsHtml||'<span style="color:var(--muted);font-size:.8rem;">Sin materias</span>'}</td>
      <td><span style="font-size:.8rem;font-weight:600;color:${typeof pct==='number'&&pct<60?'var(--accent)':'var(--sage)'}">${typeof pct==='number'?pct+'%':pct}</span></td>
      <td><button class="btn-icon" onclick="editAlumno(${al.id})">‚úèÔ∏è</button><button class="btn-icon" onclick="deleteAlumno(${al.id})">üóëÔ∏è</button></td>
    </tr>`;
  }).join('')}</tbody></table>`;
}

// CRUD ALUMNOS
function openModal(type){
  if(type==='alumno'){
    document.getElementById('modal-alumno-title').textContent='Nuevo alumno';
    document.getElementById('edit-alumno-id').value='';
    document.getElementById('al-nombre').value='';
    fillEscuelasSelect('al-escuela');updateCursosSelect('al-escuela','al-curso');
    renderNotasAlumnoModal();
  }
  if(type==='escuela'){
    document.getElementById('modal-escuela-title').textContent='Nueva escuela';
    document.getElementById('edit-escuela-id').value='';
    document.getElementById('esc-nombre').value='';document.getElementById('esc-dir').value='';
  }
  if(type==='curso'){
    document.getElementById('modal-curso-title').textContent='Nuevo curso';
    document.getElementById('edit-curso-id').value='';document.getElementById('cur-nombre').value='';
    fillEscuelasSelect('cur-escuela');
    renderMateriasChecks();
  }
  if(type==='materia'){
    document.getElementById('modal-materia-title').textContent='Nueva materia';
    document.getElementById('edit-materia-id').value='';
    document.getElementById('mat-nombre').value='';
  }
  if(type==='evento'){ openModalEvento(); return; }
  if(type==='nota'){ openModalNota(); return; }
  document.getElementById('modal-'+type).classList.add('open');
  setTimeout(()=>{const f=document.querySelector('#modal-'+type+' input:not([type=hidden])');if(f)f.focus();},100);
}
function closeModal(type){document.getElementById('modal-'+type).classList.remove('open');}
function fillEscuelasSelect(id){document.getElementById(id).innerHTML=state.escuelas.map(e=>`<option value="${e.id}">${e.nombre}</option>`).join('');}
function updateCursosSelect(escId,cId){
  const eid=parseInt(document.getElementById(escId).value);
  const cs=state.cursos.filter(c=>c.escuelaId===eid);
  document.getElementById(cId).innerHTML=cs.map(c=>`<option value="${c.id}">${c.nombre}</option>`).join('')||'<option disabled>Sin cursos</option>';
}
function renderNotasAlumnoModal(existingNotas){
  const cursoId=parseInt(document.getElementById('al-curso').value);
  const mats=cursoId?getMateriasDelCurso(cursoId):[];
  const wrap=document.getElementById('al-notas-por-materia');
  if(!mats.length){wrap.innerHTML='';return;}
  wrap.innerHTML=mats.map(m=>{
    const n=existingNotas&&existingNotas[m.id]||{};
    return`<div style="border:1px solid var(--border);border-radius:10px;padding:.8rem;margin-bottom:.6rem;">
      <div style="font-weight:700;font-size:.82rem;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:.5rem;">üìö ${m.nombre}</div>
      <div class="form-grid">
        <div class="form-row"><label>T1</label><input class="al-nota-input" data-mat="${m.id}" data-trim="t1" type="number" min="1" max="10" step="0.5" value="${n.t1??''}" placeholder="‚Äî"></div>
        <div class="form-row"><label>T2</label><input class="al-nota-input" data-mat="${m.id}" data-trim="t2" type="number" min="1" max="10" step="0.5" value="${n.t2??''}" placeholder="‚Äî"></div>
      </div>
      <div class="form-row"><label>T3</label><input class="al-nota-input" data-mat="${m.id}" data-trim="t3" type="number" min="1" max="10" step="0.5" value="${n.t3??''}" placeholder="‚Äî"></div>
    </div>`;
  }).join('');
}
function saveAlumno(){
  const nombre=document.getElementById('al-nombre').value.trim();
  if(!nombre){showToast('‚ö†Ô∏è El nombre es obligatorio');return;}
  const cursoId=parseInt(document.getElementById('al-curso').value);
  // recopilar notas por materia
  const notas={};
  document.querySelectorAll('.al-nota-input').forEach(inp=>{
    const matId=parseInt(inp.dataset.mat);
    const trim=inp.dataset.trim;
    if(!notas[matId])notas[matId]={};
    notas[matId][trim]=inp.value!==''?parseFloat(inp.value):null;
  });
  const eid=parseInt(document.getElementById('edit-alumno-id').value);
  if(eid){
    const a=state.alumnos.find(a=>a.id===eid);
    a.nombre=nombre;a.cursoId=cursoId;a.notas=notas;
    showToast('‚úÖ Alumno actualizado');
  } else {
    state.alumnos.push({id:newId(),nombre,cursoId,notas});
    showToast('‚úÖ Alumno agregado');
  }
  closeModal('alumno');saveLS();renderAll();
}
function editAlumno(id){
  const al=state.alumnos.find(a=>a.id===id);
  document.getElementById('modal-alumno-title').textContent='Editar alumno';
  document.getElementById('edit-alumno-id').value=al.id;
  document.getElementById('al-nombre').value=al.nombre;
  fillEscuelasSelect('al-escuela');
  const c=getCurso(al.cursoId);if(c)document.getElementById('al-escuela').value=c.escuelaId;
  updateCursosSelect('al-escuela','al-curso');
  document.getElementById('al-curso').value=al.cursoId;
  renderNotasAlumnoModal(al.notas||{});
  document.getElementById('modal-alumno').classList.add('open');
}
function deleteAlumno(id){
  const al=state.alumnos.find(a=>a.id===id);
  if(!confirm(`¬øEliminar a ${al.nombre}?`))return;
  state.alumnos=state.alumnos.filter(a=>a.id!==id);
  showToast('üóëÔ∏è Alumno eliminado');saveLS();renderAll();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ASISTENCIA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderFiltroAsist(){
  document.getElementById('filtro-asist-pills').innerHTML=
    state.escuelas.map(e=>`<div class="school-pill ${getCC(e.id)} ${state.filtroEscuelaAsist===e.id?'active':''}" onclick="setFiltroAsist(${e.id})"><span class="dot"></span>${e.nombre}</div>`).join('');
}
function setFiltroAsist(id){
  state.filtroEscuelaAsist=id;renderFiltroAsist();
  const cs=state.cursos.filter(c=>c.escuelaId===id);
  document.getElementById('asist-curso').innerHTML=cs.map(c=>`<option value="${c.id}">${c.nombre}</option>`).join('')||'<option disabled>Sin cursos</option>';
  updateMateriasAsist();
  renderAsistLista();
}
function updateMateriasAsist(){
  const cursoId=parseInt(document.getElementById('asist-curso').value);
  const mats=cursoId?getMateriasDelCurso(cursoId):[];
  document.getElementById('asist-materia').innerHTML=mats.map(m=>`<option value="${m.id}">${m.nombre}</option>`).join('')||'<option disabled>Sin materias</option>';
}
function renderAsistLista(){
  const cursoId=parseInt(document.getElementById('asist-curso').value);
  const materiaId=parseInt(document.getElementById('asist-materia').value);
  const fecha=document.getElementById('asist-fecha').value;
  const key=`${cursoId}_${materiaId}_${fecha}`;
  const saved=state.asistencia[key]||{};
  state.asistTemp={};
  const als=state.alumnos.filter(a=>a.cursoId===cursoId);

  if(!state.filtroEscuelaAsist||!als.length||!materiaId){
    document.getElementById('asist-lista').innerHTML='';
    document.getElementById('asist-empty').style.display='block';
    document.getElementById('asist-summary-bar').innerHTML='';
    return;
  }
  document.getElementById('asist-empty').style.display='none';
  als.forEach(al=>{state.asistTemp[al.id]={estado:saved[al.id]?.estado||null,nota:saved[al.id]?.nota||null};});
  renderSummaryBar(als);
  document.getElementById('asist-lista').innerHTML=als.map(al=>{
    const s=state.asistTemp[al.id];
    const col=getColor(state.filtroEscuelaAsist);
    return`<div class="asist-row ${s.estado?'estado-'+s.estado:''}" id="asist-row-${al.id}">
      <div class="avatar" style="background:${col}">${initials(al.nombre)}</div>
      <div class="asist-nombre">${al.nombre}</div>
      <div style="text-align:center;">
        <input class="nota-inline" type="number" min="1" max="10" step="0.5"
          value="${s.nota??''}" placeholder="‚Äî"
          onchange="setNota(${al.id},this.value)" title="Nota de clase">
        <span class="nota-inline-label">Nota clase</span>
      </div>
      <div class="asist-btns">
        <button class="asist-btn ${s.estado==='P'?'selected-P':''}" onclick="setAsist(${al.id},'P')" title="Presente">‚úì</button>
        <button class="asist-btn ${s.estado==='A'?'selected-A':''}" onclick="setAsist(${al.id},'A')" title="Ausente">‚úó</button>
        <button class="asist-btn ${s.estado==='T'?'selected-T':''}" onclick="setAsist(${al.id},'T')" title="Tarde">T</button>
      </div>
    </div>`;
  }).join('');
}
function setNota(alumnoId,val){state.asistTemp[alumnoId].nota=val!==''?parseFloat(val):null;}
function setAsist(alumnoId,estado){
  const t=state.asistTemp[alumnoId];
  t.estado=t.estado===estado?null:estado;
  const row=document.getElementById('asist-row-'+alumnoId);
  row.className=`asist-row ${t.estado?'estado-'+t.estado:''}`;
  row.querySelectorAll('.asist-btn').forEach(b=>b.classList.remove('selected-P','selected-A','selected-T'));
  if(t.estado){const map={P:0,A:1,T:2};row.querySelectorAll('.asist-btn')[map[t.estado]].classList.add('selected-'+t.estado);}
  const cursoId=parseInt(document.getElementById('asist-curso').value);
  renderSummaryBar(state.alumnos.filter(a=>a.cursoId===cursoId));
}
function guardarAsistencia(){
  const cursoId=parseInt(document.getElementById('asist-curso').value);
  const materiaId=parseInt(document.getElementById('asist-materia').value);
  const fecha=document.getElementById('asist-fecha').value;
  if(!fecha){showToast('‚ö†Ô∏è Seleccion√° una fecha');return;}
  if(!state.filtroEscuelaAsist){showToast('‚ö†Ô∏è Seleccion√° una escuela');return;}
  if(!materiaId){showToast('‚ö†Ô∏è Seleccion√° una materia');return;}
  const key=`${cursoId}_${materiaId}_${fecha}`;
  state.asistencia[key]={};
  Object.entries(state.asistTemp).forEach(([id,v])=>{state.asistencia[key][id]={...v};});
  showToast('‚úÖ Asistencia guardada para '+fmtFecha(fecha));
  saveLS();renderAll();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EXPORTAR CSV ‚Äî d√≠a
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderSummaryBar(als){
  const P=als.filter(a=>state.asistTemp[a.id]?.estado==='P').length;
  const A=als.filter(a=>state.asistTemp[a.id]?.estado==='A').length;
  const T=als.filter(a=>state.asistTemp[a.id]?.estado==='T').length;
  document.getElementById('asist-summary-bar').innerHTML=
    `<span class="sum-P">‚úì Presentes: ${P}</span>
     <span class="sum-A">‚úó Ausentes: ${A}</span>
     <span class="sum-T">T Tarde: ${T}</span>
     <span style="color:var(--muted)">/ ${als.length}</span>`;
}
function exportarCSV(){
  const cursoId=parseInt(document.getElementById('asist-curso').value);
  const materiaId=parseInt(document.getElementById('asist-materia').value);
  const fecha=document.getElementById('asist-fecha').value;
  if(!fecha||!state.filtroEscuelaAsist){showToast('‚ö†Ô∏è Guard√° primero la asistencia');return;}
  const key=`${cursoId}_${materiaId}_${fecha}`;
  const data=state.asistencia[key]||{};
  const curso=getCurso(cursoId);const esc=getEscuela(state.filtroEscuelaAsist);
  const materia=getMateria(materiaId);
  const als=state.alumnos.filter(a=>a.cursoId===cursoId);
  let csv=`Escuela,Curso,Materia,Fecha,Alumno,Estado,Nota clase\n`;
  als.forEach(al=>{
    const d=data[al.id]||{};
    csv+=`"${esc?.nombre||''}","${curso?.nombre||''}","${materia?.nombre||''}","${fmtFecha(fecha)}","${al.nombre}","${d.estado||'‚Äî'}","${d.nota??'‚Äî'}"\n`;
  });
  descargar(csv,`asistencia_${curso?.nombre||''}_${materia?.nombre||''}_${fecha}.csv`);
  showToast('‚¨áÔ∏è CSV descargado');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HISTORIAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderFiltroHist(){
  document.getElementById('filtro-hist-pills').innerHTML=
    state.escuelas.map(e=>`<div class="school-pill ${getCC(e.id)} ${state.filtroEscuelaHist===e.id?'active':''}" onclick="setFiltroHist(${e.id})"><span class="dot"></span>${e.nombre}</div>`).join('');
}
function setFiltroHist(id){
  state.filtroEscuelaHist=id;renderFiltroHist();
  const cs=state.cursos.filter(c=>c.escuelaId===id);
  document.getElementById('hist-curso').innerHTML=cs.map(c=>`<option value="${c.id}">${c.nombre}</option>`).join('')||'<option disabled>Sin cursos</option>';
  updateMateriasHist();
  renderHistorial();
}
function updateMateriasHist(){
  const cursoId=parseInt(document.getElementById('hist-curso').value);
  const mats=cursoId?getMateriasDelCurso(cursoId):[];
  document.getElementById('hist-materia').innerHTML=mats.map(m=>`<option value="${m.id}">${m.nombre}</option>`).join('')||'<option disabled>Sin materias</option>';
}
function renderHistorial(){
  const wrap=document.getElementById('historial-wrap');
  const cursoId=parseInt(document.getElementById('hist-curso').value);
  const materiaId=parseInt(document.getElementById('hist-materia').value);
  if(!state.filtroEscuelaHist||isNaN(cursoId)||isNaN(materiaId)){wrap.innerHTML='<div class="empty-state"><div class="big">üìä</div><div>Seleccion√° escuela, curso y materia</div></div>';return;}
  const als=state.alumnos.filter(a=>a.cursoId===cursoId);
  const prefix=`${cursoId}_${materiaId}_`;
  const fechas=[...new Set(Object.keys(state.asistencia).filter(k=>k.startsWith(prefix)).map(k=>k.replace(prefix,'')))].sort();
  if(!fechas.length){wrap.innerHTML='<div class="empty-state"><div class="big">üìÖ</div><div>Sin registros para este curso y materia a√∫n.</div></div>';return;}
  const estadoClases={P:'‚úì Presente',A:'‚úó Ausente',T:'T Tarde',null:'‚Äî'};
  const resumen=als.map(al=>{
    const P=fechas.filter(f=>state.asistencia[`${prefix}${f}`]?.[al.id]?.estado==='P').length;
    const A=fechas.filter(f=>state.asistencia[`${prefix}${f}`]?.[al.id]?.estado==='A').length;
    const T=fechas.filter(f=>state.asistencia[`${prefix}${f}`]?.[al.id]?.estado==='T').length;
    const pct=fechas.length?Math.round(P/fechas.length*100):0;
    return{al,P,A,T,pct};
  });
  wrap.innerHTML=`
  <div class="hist-legend">
    <span><span class="legend-dot hP"></span>Presente</span>
    <span><span class="legend-dot hA"></span>Ausente</span>
    <span><span class="legend-dot hT"></span>Tarde</span>
    <span><span class="legend-dot hN"></span>Sin dato</span>
  </div>
  <div class="card" style="padding:0;overflow-x:auto;">
  <table class="hist-table"><thead><tr>
    <th style="min-width:160px;">Alumno</th>
    ${fechas.map(f=>{
      const t=state.temas[`${prefix}${f}`]||{};
      return`<th style="text-align:center;min-width:80px;">
        <div>${fmtFecha(f)}</div>
        ${t.titulo?`<div style="font-size:.62rem;color:var(--gold);font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:90px;" title="${t.titulo}${t.descripcion?' ‚Äî '+t.descripcion:''}">üìñ ${t.titulo}</div>`:''}
      </th>`;
    }).join('')}
    <th style="text-align:center;">% Asist.</th>
    <th style="text-align:center;">Notas clase</th>
  </tr></thead><tbody>
  ${resumen.map(({al,P,A,T,pct})=>{
    const col=getColor(state.filtroEscuelaHist);
    const notasClase=fechas.map(f=>state.asistencia[`${prefix}${f}`]?.[al.id]?.nota).filter(n=>n!=null);
    const promNotas=notasClase.length?(notasClase.reduce((a,b)=>a+b,0)/notasClase.length).toFixed(1):null;
    return`<tr>
      <td><div class="alumno-link" style="display:flex;align-items:center;" onclick="abrirTrayectoria(${al.id})"><div class="avatar" style="background:${col}">${initials(al.nombre)}</div><span class="av-nombre">${al.nombre}</span></div></td>
      ${fechas.map(f=>{
        const d=state.asistencia[`${prefix}${f}`]?.[al.id];
        const e=d?.estado||null;
        const cls=e==='P'?'hP':e==='A'?'hA':e==='T'?'hT':'hN';
        return`<td style="text-align:center;"><div class="hist-dot ${cls}" data-tip="${estadoClases[e]||'Sin registro'} ‚Äî ${fmtFecha(f)}"></div></td>`;
      }).join('')}
      <td style="text-align:center;"><span style="font-weight:700;color:${pct<60?'var(--accent)':pct<80?'#9a7000':'var(--sage)'};">${pct}%</span><br><span style="font-size:.65rem;color:var(--muted);">${P}P ${A}A ${T}T</span></td>
      <td style="text-align:center;">${promNotas?`<span class="nota-badge ${notaClass(parseFloat(promNotas))}">${promNotas}</span>`:'<span style="color:var(--muted);">‚Äî</span>'}</td>
    </tr>`;
  }).join('')}
  </tbody></table></div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EXPORTAR CSV historial completo
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function exportarCSVHistorial(){
  const cursoId=parseInt(document.getElementById('hist-curso').value);
  const materiaId=parseInt(document.getElementById('hist-materia').value);
  if(!state.filtroEscuelaHist||isNaN(cursoId)||isNaN(materiaId)){showToast('‚ö†Ô∏è Seleccion√° escuela, curso y materia');return;}
  const als=state.alumnos.filter(a=>a.cursoId===cursoId);
  const prefix=`${cursoId}_${materiaId}_`;
  const fechas=[...new Set(Object.keys(state.asistencia).filter(k=>k.startsWith(prefix)).map(k=>k.replace(prefix,'')))].sort();
  const curso=getCurso(cursoId);const esc=getEscuela(state.filtroEscuelaHist);const materia=getMateria(materiaId);
  let csv=`Escuela,Curso,Materia,Alumno,Fecha,Estado,Nota clase\n`;
  als.forEach(al=>{
    fechas.forEach(f=>{
      const d=state.asistencia[`${prefix}${f}`]?.[al.id]||{};
      csv+=`"${esc?.nombre||''}","${curso?.nombre||''}","${materia?.nombre||''}","${al.nombre}","${fmtFecha(f)}","${d.estado||'‚Äî'}","${d.nota??'‚Äî'}"\n`;
    });
  });
  descargar(csv,`historial_${curso?.nombre||''}_${materia?.nombre||''}.csv`);
  showToast('‚¨áÔ∏è Historial exportado');
}

function descargar(content,filename){
  const a=document.createElement('a');
  a.href='data:text/csv;charset=utf-8,'+encodeURIComponent('\uFEFF'+content);
  a.download=filename;a.click();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ESCUELAS & CURSOS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderEscuelas(){
  const lista=document.getElementById('lista-escuelas');
  lista.innerHTML=state.escuelas.length?state.escuelas.map((e,i)=>`
    <div class="escuela-card">
      <div class="esc-dot" style="background:${COLORS[i%COLORS.length]}"></div>
      <div class="esc-info"><div class="esc-nombre">${e.nombre}</div>
      <div class="esc-meta">${e.dir||'Sin direcci√≥n'} ¬∑ ${state.cursos.filter(c=>c.escuelaId===e.id).length} curso(s)</div></div>
      <div class="esc-actions">
        <button class="btn btn-ghost btn-sm" onclick="editEscuela(${e.id})">‚úèÔ∏è Editar</button>
        <button class="btn btn-danger btn-sm" onclick="deleteEscuela(${e.id})">üóëÔ∏è</button>
      </div>
    </div>`).join(''):'<div class="empty-state"><div class="big">üè´</div><div>Sin escuelas.</div></div>';

  const lc=document.getElementById('lista-cursos');
  lc.innerHTML=state.cursos.length?`<div class="card" style="padding:0;overflow:hidden;"><table>
    <thead><tr><th>Curso</th><th>Escuela</th><th>Materias</th><th>Preceptor/a</th><th>Tutor/a</th><th>Alumnos</th><th></th></tr></thead>
    <tbody>${state.cursos.map(c=>{
      const e=getEscuela(c.escuelaId),col=e?getColor(e.id):'#888';
      const mats=getMateriasDelCurso(c.id);
      return`<tr><td><strong>${c.nombre}</strong></td>
      <td><span style="color:${col};font-weight:600;font-size:.8rem;">${e?e.nombre:'‚Äî'}</span></td>
      <td><span style="font-size:.78rem;">${mats.length?mats.map(m=>m.nombre).join(', '):'<span style="color:var(--muted)">Sin materias</span>'}</span></td>
      <td><span style="font-size:.78rem;">${c.preceptor||'<span style="color:var(--muted)">‚Äî</span>'}</span></td>
      <td><span style="font-size:.78rem;">${c.tutor||'<span style="color:var(--muted)">‚Äî</span>'}</span></td>
      <td>${state.alumnos.filter(a=>a.cursoId===c.id).length}</td>
      <td><button class="btn-icon" onclick="editCurso(${c.id})">‚úèÔ∏è</button><button class="btn-icon" onclick="deleteCurso(${c.id})">üóëÔ∏è</button></td></tr>`;
    }).join('')}</tbody></table></div>`:'<div style="color:var(--muted);font-size:.88rem;">Sin cursos.</div>';

  // Materias
  const lm=document.getElementById('lista-materias');
  if(!lm)return;
  lm.innerHTML=state.materias.length?`<div class="card" style="padding:0;overflow:hidden;"><table>
    <thead><tr><th>Materia</th><th>Cursos asignados</th><th></th></tr></thead>
    <tbody>${state.materias.map(m=>{
      const cursosConMateria=state.cursos.filter(c=>(state.cursoMaterias[c.id]||[]).includes(m.id));
      return`<tr><td><strong>${m.nombre}</strong></td>
      <td><span style="font-size:.78rem;color:var(--muted);">${cursosConMateria.length?cursosConMateria.map(c=>c.nombre).join(', '):'Sin asignar'}</span></td>
      <td><button class="btn-icon" onclick="editMateria(${m.id})">‚úèÔ∏è</button><button class="btn-icon" onclick="deleteMateria(${m.id})">üóëÔ∏è</button></td></tr>`;
    }).join('')}</tbody></table></div>`:'<div style="color:var(--muted);font-size:.88rem;">Sin materias. Agreg√° una para poder asignarla a los cursos.</div>';
}
function saveEscuela(){
  const nombre=document.getElementById('esc-nombre').value.trim();
  if(!nombre){showToast('‚ö†Ô∏è Nombre obligatorio');return;}
  const dir=document.getElementById('esc-dir').value.trim();
  const eid=parseInt(document.getElementById('edit-escuela-id').value);
  if(eid){const e=getEscuela(eid);e.nombre=nombre;e.dir=dir;showToast('‚úÖ Escuela actualizada');}
  else{state.escuelas.push({id:newId(),nombre,dir});showToast('‚úÖ Escuela agregada');}
  closeModal('escuela');saveLS();renderAll();
}
function editEscuela(id){
  const e=getEscuela(id);
  document.getElementById('modal-escuela-title').textContent='Editar escuela';
  document.getElementById('edit-escuela-id').value=e.id;
  document.getElementById('esc-nombre').value=e.nombre;
  document.getElementById('esc-dir').value=e.dir||'';
  document.getElementById('modal-escuela').classList.add('open');
}
function deleteEscuela(id){
  const e=getEscuela(id);const cs=state.cursos.filter(c=>c.escuelaId===id);
  const als=state.alumnos.filter(a=>cs.some(c=>c.id===a.cursoId));
  if(!confirm(`¬øEliminar "${e.nombre}" con ${cs.length} curso(s) y ${als.length} alumno(s)?`))return;
  const cids=cs.map(c=>c.id);
  state.alumnos=state.alumnos.filter(a=>!cids.includes(a.cursoId));
  state.cursos=state.cursos.filter(c=>c.escuelaId!==id);
  state.escuelas=state.escuelas.filter(x=>x.id!==id);
  showToast('üóëÔ∏è Escuela eliminada');saveLS();renderAll();
}
function renderMateriasChecks(selectedIds){
  const checks=document.getElementById('cur-materias-checks');
  if(!checks)return;
  checks.innerHTML=state.materias.map(m=>{
    const checked=selectedIds?selectedIds.includes(m.id):false;
    return`<label style="display:flex;align-items:center;gap:.35rem;padding:.35rem .7rem;border:1.5px solid ${checked?'var(--sage)':'var(--border)'};border-radius:8px;cursor:pointer;font-size:.82rem;font-weight:600;background:${checked?'rgba(74,124,89,.08)':'white'};transition:all .15s;" id="mat-label-${m.id}">
      <input type="checkbox" value="${m.id}" ${checked?'checked':''} onchange="updateMatLabel(${m.id},this.checked)" style="width:14px;height:14px;">
      ${m.nombre}
    </label>`;
  }).join('')||'<span style="font-size:.82rem;color:var(--muted);">Sin materias creadas a√∫n. Cre√° una primero.</span>';
}
function updateMatLabel(id,checked){
  const lbl=document.getElementById('mat-label-'+id);
  if(!lbl)return;
  lbl.style.borderColor=checked?'var(--sage)':'var(--border)';
  lbl.style.background=checked?'rgba(74,124,89,.08)':'white';
}
function saveCurso(){
  const nombre=document.getElementById('cur-nombre').value.trim();
  if(!nombre){showToast('‚ö†Ô∏è Nombre obligatorio');return;}
  const escuelaId=parseInt(document.getElementById('cur-escuela').value);
  const preceptor=document.getElementById('cur-preceptor').value.trim();
  const tutor=document.getElementById('cur-tutor').value.trim();
  const materiaIds=[...document.querySelectorAll('#cur-materias-checks input:checked')].map(i=>parseInt(i.value));
  const eid=parseInt(document.getElementById('edit-curso-id').value);
  if(eid){
    const c=state.cursos.find(c=>c.id===eid);
    c.nombre=nombre;c.escuelaId=escuelaId;c.preceptor=preceptor;c.tutor=tutor;
    state.cursoMaterias[eid]=materiaIds;
    showToast('‚úÖ Curso actualizado');
  } else {
    const id=newId();
    state.cursos.push({id,nombre,escuelaId,preceptor,tutor});
    state.cursoMaterias[id]=materiaIds;
    showToast('‚úÖ Curso agregado');
  }
  closeModal('curso');saveLS();renderAll();
}
function editCurso(id){
  const c=state.cursos.find(c=>c.id===id);
  document.getElementById('modal-curso-title').textContent='Editar curso';
  document.getElementById('edit-curso-id').value=c.id;
  document.getElementById('cur-nombre').value=c.nombre;
  document.getElementById('cur-preceptor').value=c.preceptor||'';
  document.getElementById('cur-tutor').value=c.tutor||'';
  fillEscuelasSelect('cur-escuela');
  document.getElementById('cur-escuela').value=c.escuelaId;
  renderMateriasChecks(state.cursoMaterias[id]||[]);
  document.getElementById('modal-curso').classList.add('open');
}
function saveMateria(){
  const nombre=document.getElementById('mat-nombre').value.trim();
  if(!nombre){showToast('‚ö†Ô∏è Nombre obligatorio');return;}
  const eid=parseInt(document.getElementById('edit-materia-id').value);
  if(eid){state.materias.find(m=>m.id===eid).nombre=nombre;showToast('‚úÖ Materia actualizada');}
  else{state.materias.push({id:newId(),nombre});showToast('‚úÖ Materia agregada');}
  closeModal('materia');saveLS();renderAll();
}
function editMateria(id){
  const m=getMateria(id);
  document.getElementById('modal-materia-title').textContent='Editar materia';
  document.getElementById('edit-materia-id').value=m.id;
  document.getElementById('mat-nombre').value=m.nombre;
  document.getElementById('modal-materia').classList.add('open');
}
function deleteMateria(id){
  const m=getMateria(id);
  if(!confirm(`¬øEliminar la materia "${m.nombre}"?\nSe perder√°n todos los registros de seguimiento y asistencia de esta materia.`))return;
  state.materias=state.materias.filter(x=>x.id!==id);
  Object.keys(state.cursoMaterias).forEach(cid=>{state.cursoMaterias[cid]=state.cursoMaterias[cid].filter(mid=>mid!==id);});
  showToast('üóëÔ∏è Materia eliminada');saveLS();renderAll();
}
function deleteCurso(id){
  const c=state.cursos.find(c=>c.id===id);
  if(!confirm(`¬øEliminar "${c.nombre}"?`))return;
  state.alumnos=state.alumnos.filter(a=>a.cursoId!==id);
  state.cursos=state.cursos.filter(x=>x.id!==id);
  showToast('üóëÔ∏è Curso eliminado');saveLS();renderAll();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SEGUIMIENTO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const INDICADORES=['interpreta','analiza','resuelve','transmite'];
const IND_LABELS={interpreta:'üß† Interpreta',analiza:'üîç Analiza',resuelve:'‚öôÔ∏è Resuelve',transmite:'üí¨ Transmite'};

function getSeg(alumnoId,materiaId,fecha){
  if(!state.seguimiento[alumnoId])state.seguimiento[alumnoId]={};
  if(!state.seguimiento[alumnoId][materiaId])state.seguimiento[alumnoId][materiaId]={};
  if(!state.seguimiento[alumnoId][materiaId][fecha])state.seguimiento[alumnoId][materiaId][fecha]={interpreta:null,analiza:null,resuelve:null,transmite:null,obs:''};
  return state.seguimiento[alumnoId][materiaId][fecha];
}
function getSegLatest(alumnoId,materiaId){
  const fechas=Object.keys(state.seguimiento[alumnoId]?.[materiaId]||{}).sort();
  return fechas.length?state.seguimiento[alumnoId][materiaId][fechas[fechas.length-1]]:null;
}

function renderFiltroSeg(){
  document.getElementById('filtro-seg-pills').innerHTML=
    state.escuelas.map(e=>`<div class="school-pill ${getCC(e.id)} ${state.filtroEscuelaSeg===e.id?'active':''}" onclick="setFiltroSeg(${e.id})"><span class="dot"></span>${e.nombre}</div>`).join('');
}
function setFiltroSeg(id){
  state.filtroEscuelaSeg=id;renderFiltroSeg();
  const cs=state.cursos.filter(c=>c.escuelaId===id);
  document.getElementById('seg-curso').innerHTML=cs.map(c=>`<option value="${c.id}">${c.nombre}</option>`).join('')||'<option disabled>Sin cursos</option>';
  updateMateriasSeg();
  renderSeguimiento();
}
function updateMateriasSeg(){
  const cursoId=parseInt(document.getElementById('seg-curso').value);
  const mats=cursoId?getMateriasDelCurso(cursoId):[];
  document.getElementById('seg-materia').innerHTML=mats.map(m=>`<option value="${m.id}">${m.nombre}</option>`).join('')||'<option disabled>Sin materias</option>';
}

function segEstadoClass(v){
  if(v==='ok')return'ind-btn sel-ok';
  if(v==='no')return'ind-btn sel-no';
  if(v==='ep')return'ind-btn sel-ep';
  return'ind-btn';
}
function segChip(al,materiaId,fecha){
  const s=state.seguimiento[al.id]?.[materiaId]?.[fecha]||{};
  const vals=INDICADORES.map(i=>s[i]).filter(v=>v);
  if(!vals.length)return'<span class="seg-chip chip-none">Sin datos</span>';
  const logrados=vals.filter(v=>v==='ok').length;
  if(logrados===INDICADORES.length)return'<span class="seg-chip chip-full">‚úì Todo logrado</span>';
  if(logrados>0||vals.some(v=>v==='ep'))return`<span class="seg-chip chip-part">${logrados}/${INDICADORES.length} logrado</span>`;
  return'<span class="seg-chip chip-none">‚úó No logrado</span>';
}

function renderSeguimiento(){
  const wrap=document.getElementById('seg-lista');
  const empty=document.getElementById('seg-empty');
  if(!state.filtroEscuelaSeg){wrap.innerHTML='';empty.style.display='block';return;}
  const cursoId=parseInt(document.getElementById('seg-curso').value);
  const materiaId=parseInt(document.getElementById('seg-materia').value);
  const fecha=document.getElementById('seg-fecha').value;
  const als=state.alumnos.filter(a=>a.cursoId===cursoId);
  if(!als.length||!materiaId){wrap.innerHTML='<div class="empty-state"><div class="big">üë§</div><div>Sin alumnos o materia.</div></div>';empty.style.display='none';return;}
  empty.style.display='none';
  const col=getColor(state.filtroEscuelaSeg);
  wrap.innerHTML=als.map(al=>{
    const s=getSeg(al.id,materiaId,fecha);
    return`<div class="seg-row" id="seg-row-${al.id}">
      <div class="seg-alumno-cell">
        <div class="avatar" style="background:${col};cursor:pointer;" onclick="abrirDetalleSeg(${al.id})" title="Ver historial completo">${initials(al.nombre)}</div>
        <span style="cursor:pointer;" onclick="abrirDetalleSeg(${al.id})">${al.nombre}</span>
      </div>
      ${INDICADORES.map((ind,i)=>{
        const labels={interpreta:'üß† Interpreta',analiza:'üîç Analiza',resuelve:'‚öôÔ∏è Resuelve',transmite:'üí¨ Transmite'};
        return`<div class="ind-toggle ${i>=2?'hide-mobile':''}" style="flex-direction:column;gap:.25rem;">
          <div style="font-size:.64rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.4px;display:none;" class="ind-label-mobile">${labels[ind]}</div>
          <div style="display:flex;gap:.25rem;justify-content:center;">
            <button class="${segEstadoClass(s[ind]==='ok'?'ok':null)} ind-btn" onclick="cycleInd(${al.id},'${ind}','ok')" title="Logrado">‚úì</button>
            <button class="${segEstadoClass(s[ind]==='ep'?'ep':null)} ind-btn" onclick="cycleInd(${al.id},'${ind}','ep')" title="En proceso">~</button>
            <button class="${segEstadoClass(s[ind]==='no'?'no':null)} ind-btn" onclick="cycleInd(${al.id},'${ind}','no')" title="No logrado">‚úó</button>
          </div>
        </div>`;
      }).join('')}
      <div id="seg-chip-${al.id}">${segChip(al,materiaId,fecha)}</div>
      <div class="hide-mobile">
        <textarea class="obs-input" rows="1" placeholder="Observaci√≥n‚Ä¶"
          onchange="setObsSeg(${al.id},this.value)"
          style="font-size:.75rem;">${s.obs||''}</textarea>
      </div>
    </div>`;
  }).join('');
}

function cycleInd(alumnoId,indicador,valor){
  const fecha=document.getElementById('seg-fecha').value;
  const materiaId=parseInt(document.getElementById('seg-materia').value);
  if(!fecha){showToast('‚ö†Ô∏è Seleccion√° una fecha de registro');return;}
  const s=getSeg(alumnoId,materiaId,fecha);
  s[indicador]=s[indicador]===valor?null:valor;
  const row=document.getElementById('seg-row-'+alumnoId);
  if(!row)return;
  const indIdx=INDICADORES.indexOf(indicador);
  const toggles=row.querySelectorAll('.ind-toggle');
  if(toggles[indIdx]){
    const btns=toggles[indIdx].querySelectorAll('.ind-btn');
    const map={ok:0,ep:1,no:2};
    btns.forEach(b=>b.classList.remove('sel-ok','sel-ep','sel-no'));
    if(s[indicador])btns[map[s[indicador]]].classList.add('sel-'+s[indicador]);
  }
  const chipEl=document.getElementById('seg-chip-'+alumnoId);
  if(chipEl)chipEl.innerHTML=segChip({id:alumnoId},materiaId,fecha);
  saveLS();
}
function setObsSeg(alumnoId,valor){
  const fecha=document.getElementById('seg-fecha').value;
  const materiaId=parseInt(document.getElementById('seg-materia').value);
  if(!fecha)return;
  const s=getSeg(alumnoId,materiaId,fecha);
  s.obs=valor;saveLS();
}

function abrirDetalleSeg(alumnoId){
  const al=state.alumnos.find(a=>a.id===alumnoId);
  const col=getColor(state.filtroEscuelaSeg||0);
  const materiaId=parseInt(document.getElementById('seg-materia').value);
  const materia=getMateria(materiaId);
  document.getElementById('seg-modal-title').innerHTML=
    `<div style="display:flex;align-items:center;gap:.6rem;">
      <div class="avatar" style="background:${col}">${initials(al.nombre)}</div>
      <div>${al.nombre}<div style="font-size:.75rem;color:var(--muted);font-family:'DM Sans',sans-serif;">${materia?materia.nombre:''}</div></div>
    </div>`;
  document.getElementById('seg-modal-alumno-id').value=alumnoId;
  const fecha=document.getElementById('seg-fecha').value;
  const s=getSeg(alumnoId,materiaId,fecha);
  const histFechas=Object.keys(state.seguimiento[alumnoId]?.[materiaId]||{}).sort().reverse().slice(0,5);
  document.getElementById('seg-modal-content').innerHTML=`
    <div style="margin-bottom:.8rem;">
      <label>Fecha de este registro</label>
      <div style="display:flex;align-items:center;gap:.5rem;margin-top:.25rem;">
        <input type="date" id="seg-det-fecha" value="${fecha}" style="flex:1;">
        <input type="hidden" id="seg-det-materia" value="${materiaId}">
      </div>
    </div>
    <div class="det-grid">
      ${INDICADORES.map(ind=>`
      <div class="det-ind-card">
        <div class="det-ind-name">${IND_LABELS[ind]}</div>
        <div class="det-btns">
          <button class="det-btn ${s[ind]==='ok'?'sel-ok':''}" id="det-${ind}-ok" onclick="toggleDetBtn('${ind}','ok')">‚úì Logrado</button>
          <button class="det-btn ${s[ind]==='ep'?'sel-ep':''}" id="det-${ind}-ep" onclick="toggleDetBtn('${ind}','ep')">~ En proceso</button>
          <button class="det-btn ${s[ind]==='no'?'sel-no':''}" id="det-${ind}-no" onclick="toggleDetBtn('${ind}','no')">‚úó No logrado</button>
        </div>
      </div>`).join('')}
    </div>
    <div class="form-row">
      <label>Observaciones</label>
      <textarea class="obs-input" id="seg-obs" rows="3" placeholder="Notas adicionales sobre el alumno‚Ä¶">${s.obs||''}</textarea>
    </div>
    ${histFechas.length>1?`
    <div style="margin-top:.8rem;">
      <label>Historial reciente</label>
      <div style="margin-top:.4rem;display:flex;flex-direction:column;gap:.4rem;">
        ${histFechas.filter(f=>f!==fecha).slice(0,4).map(f=>{
          const hs=state.seguimiento[alumnoId][materiaId][f];
          return`<div style="display:flex;align-items:center;gap:.6rem;font-size:.78rem;padding:.4rem .6rem;background:var(--paper);border-radius:8px;border:1px solid var(--border);">
            <span class="seg-date-tag">${fmtFecha(f)}</span>
            ${INDICADORES.map(i=>`<span title="${IND_LABELS[i]}">${hs[i]==='ok'?'‚úì':hs[i]==='ep'?'~':hs[i]==='no'?'‚úó':'¬∑'}</span>`).join('')}
            <span style="color:var(--muted);font-size:.72rem;margin-left:.3rem;">${hs.obs||''}</span>
          </div>`;
        }).join('')}
      </div>
    </div>`:''}
  `;
  document.getElementById('modal-seguimiento').classList.add('open');
}
let _detTemp={};
function toggleDetBtn(ind,val){
  const alumnoId=parseInt(document.getElementById('seg-modal-alumno-id').value);
  const fecha=document.getElementById('seg-det-fecha').value||document.getElementById('seg-fecha').value;
  const materiaId=parseInt(document.getElementById('seg-det-materia').value);
  const s=getSeg(alumnoId,materiaId,fecha);
  s[ind]=s[ind]===val?null:val;
  ['ok','ep','no'].forEach(v=>{
    const b=document.getElementById(`det-${ind}-${v}`);
    if(b){b.classList.remove('sel-ok','sel-ep','sel-no');if(s[ind]===v)b.classList.add('sel-'+v);}
  });
}
function guardarDetalleSeg(){
  const alumnoId=parseInt(document.getElementById('seg-modal-alumno-id').value);
  const fecha=document.getElementById('seg-det-fecha').value||document.getElementById('seg-fecha').value;
  const materiaId=parseInt(document.getElementById('seg-det-materia').value);
  if(!fecha){showToast('‚ö†Ô∏è Seleccion√° una fecha');return;}
  const s=getSeg(alumnoId,materiaId,fecha);
  s.obs=document.getElementById('seg-obs').value;
  showToast('‚úÖ Seguimiento guardado');
  saveLS();closeModal('seguimiento');renderSeguimiento();
}

function exportarCSVSeguimiento(){
  if(!state.filtroEscuelaSeg){showToast('‚ö†Ô∏è Seleccion√° una escuela');return;}
  const cursoId=parseInt(document.getElementById('seg-curso').value);
  const als=state.alumnos.filter(a=>a.cursoId===cursoId);
  const curso=getCurso(cursoId);const esc=getEscuela(state.filtroEscuelaSeg);
  let csv=`Escuela,Curso,Alumno,Fecha,Interpreta,Analiza,Resuelve,Transmite,Observaciones\n`;
  als.forEach(al=>{
    const fechas=Object.keys(state.seguimiento[al.id]||{}).sort();
    if(!fechas.length){
      csv+=`"${esc?.nombre||''}","${curso?.nombre||''}","${al.nombre}","‚Äî","‚Äî","‚Äî","‚Äî","‚Äî",""\n`;
    } else {
      fechas.forEach(f=>{
        const s=state.seguimiento[al.id][f];
        const fmt=v=>v==='ok'?'Logrado':v==='ep'?'En proceso':v==='no'?'No logrado':'‚Äî';
        csv+=`"${esc?.nombre||''}","${curso?.nombre||''}","${al.nombre}","${fmtFecha(f)}","${fmt(s.interpreta)}","${fmt(s.analiza)}","${fmt(s.resuelve)}","${fmt(s.transmite)}","${s.obs||''}"\n`;
      });
    }
  });
  descargar(csv,`seguimiento_${curso?.nombre||''}.csv`);
  showToast('‚¨áÔ∏è Seguimiento exportado');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CALENDARIO & EVENTOS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function diasHasta(fecha){
  const hoy=new Date(); hoy.setHours(0,0,0,0);
  const ev=new Date(fecha+'T00:00:00');
  return Math.round((ev-hoy)/(1000*60*60*24));
}
function diasBadge(fecha){
  const d=diasHasta(fecha);
  if(d<0)return`<span class="dias-badge db-past">Pasado</span>`;
  if(d===0)return`<span class="dias-badge db-hoy">¬°Hoy!</span>`;
  if(d<=3)return`<span class="dias-badge db-pronto">En ${d}d</span>`;
  return`<span class="dias-badge db-ok">En ${d}d</span>`;
}

function renderCalendario(){
  const meses=['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
  const diasSem=['Dom','Lun','Mar','Mi√©','Jue','Vie','S√°b'];
  const {year,month}=calView;
  document.getElementById('cal-mes-label').textContent=`${meses[month]} ${year}`;

  const today=new Date(); today.setHours(0,0,0,0);
  const firstDay=new Date(year,month,1).getDay();
  const daysInMonth=new Date(year,month+1,0).getDate();
  const daysInPrev=new Date(year,month,0).getDate();

  let html=diasSem.map(d=>`<div class="cal-day-header">${d}</div>`).join('');

  // prev month padding
  for(let i=0;i<firstDay;i++){
    const d=daysInPrev-firstDay+1+i;
    html+=`<div class="cal-cell other-month"><div class="cal-num">${d}</div></div>`;
  }

  // current month
  for(let d=1;d<=daysInMonth;d++){
    const dateStr=`${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const isToday=new Date(year,month,d).getTime()===today.getTime();
    const evs=state.eventos.filter(e=>e.fecha===dateStr);
    const hasEv=evs.length>0;
    html+=`<div class="cal-cell ${isToday?'today':''} ${hasEv?'has-event':''}" ${hasEv?`onclick="verDiaEvento('${dateStr}')"`:''}">
      <div class="cal-num">${d}</div>
      ${evs.slice(0,2).map(e=>`<span class="cal-event-dot ${TIPO_CLASS[e.tipo]}">${e.titulo}</span>`).join('')}
      ${evs.length>2?`<span style="font-size:.58rem;color:var(--muted);">+${evs.length-2} m√°s</span>`:''}
    </div>`;
  }

  // next month padding
  const total=firstDay+daysInMonth;
  const nextPad=(7-total%7)%7;
  for(let i=1;i<=nextPad;i++) html+=`<div class="cal-cell other-month"><div class="cal-num">${i}</div></div>`;

  document.getElementById('cal-grid').innerHTML=html;
  renderListaEventos();
}

function calPrev(){calView.month--;if(calView.month<0){calView.month=11;calView.year--;}renderCalendario();}
function calNext(){calView.month++;if(calView.month>11){calView.month=0;calView.year++;}renderCalendario();}

function verDiaEvento(fecha){
  const evs=state.eventos.filter(e=>e.fecha===fecha);
  if(!evs.length)return;
  const lista=evs.map(e=>{
    const esc=e.escuelaId?getEscuela(e.escuelaId):null;
    return`<div class="ev-item">
      <div class="ev-type-dot" style="background:${TIPO_COLOR[e.tipo]}"></div>
      <div class="ev-info"><div class="ev-nombre">${e.titulo}</div>
      <div class="ev-meta">${TIPO_LABEL[e.tipo]}${esc?' ¬∑ '+esc.nombre:''}${e.obs?' ¬∑ '+e.obs:''}</div></div>
      <div style="display:flex;gap:.3rem;">
        <button class="btn-icon" onclick="editEvento(${e.id})">‚úèÔ∏è</button>
        <button class="btn-icon" onclick="deleteEvento(${e.id})">üóëÔ∏è</button>
      </div>
    </div>`;
  }).join('');
  showToast(`üìÖ ${evs.length} evento(s) el ${fmtFecha(fecha)}`);
}

function renderListaEventos(){
  const hoy=new Date(); hoy.setHours(0,0,0,0);
  const sorted=[...state.eventos].sort((a,b)=>a.fecha.localeCompare(b.fecha));
  if(!sorted.length){
    document.getElementById('lista-eventos').innerHTML='<div style="color:var(--muted);font-size:.86rem;text-align:center;padding:1rem;">Sin eventos. Us√° + para agregar.</div>';
    return;
  }
  document.getElementById('lista-eventos').innerHTML=sorted.map(e=>{
    const esc=e.escuelaId?getEscuela(e.escuelaId):null;
    const d=diasHasta(e.fecha);
    const past=d<0;
    return`<div class="ev-item" style="${past?'opacity:.5':''}">
      <div class="ev-type-dot" style="background:${TIPO_COLOR[e.tipo]}"></div>
      <div class="ev-info">
        <div class="ev-nombre">${e.titulo}</div>
        <div class="ev-meta">${fmtFecha(e.fecha)} ¬∑ ${TIPO_LABEL[e.tipo]}${esc?' ¬∑ '+esc.nombre:' ¬∑ Todas las escuelas'}</div>
        ${e.obs?`<div class="ev-meta" style="font-style:italic;">${e.obs}</div>`:''}
      </div>
      <div style="display:flex;flex-direction:column;align-items:flex-end;gap:.3rem;">
        ${diasBadge(e.fecha)}
        <div style="display:flex;gap:.2rem;">
          <button class="btn-icon" onclick="editEvento(${e.id})">‚úèÔ∏è</button>
          <button class="btn-icon" onclick="deleteEvento(${e.id})">üóëÔ∏è</button>
        </div>
      </div>
    </div>`;
  }).join('');
}

function renderProximosInicio(){
  const hoy=new Date(); hoy.setHours(0,0,0,0);
  const proximos=state.eventos
    .filter(e=>diasHasta(e.fecha)>=0)
    .sort((a,b)=>a.fecha.localeCompare(b.fecha))
    .slice(0,4);
  const el=document.getElementById('proximos-inicio');
  if(!el)return;
  if(!proximos.length){
    el.innerHTML='<div style="color:var(--muted);font-size:.84rem;">Sin eventos pr√≥ximos.</div>';
    return;
  }
  el.innerHTML=proximos.map(e=>{
    const d=diasHasta(e.fecha);
    const esc=e.escuelaId?getEscuela(e.escuelaId):null;
    return`<div class="prox-item tipo-${e.tipo}">
      <div class="prox-nombre">${e.titulo}<br><span style="font-weight:400;font-size:.74rem;color:var(--muted);">${esc?esc.nombre:'Todas'}</span></div>
      <div class="prox-fecha">${fmtFecha(e.fecha)}</div>
      ${diasBadge(e.fecha)}
    </div>`;
  }).join('');
}

// CRUD EVENTOS
function openModalEvento(){
  document.getElementById('modal-evento-title').textContent='Nuevo evento';
  document.getElementById('edit-evento-id').value='';
  document.getElementById('ev-titulo').value='';
  document.getElementById('ev-tipo').value='examen';
  document.getElementById('ev-fecha').value=new Date().toISOString().slice(0,10);
  document.getElementById('ev-obs').value='';
  // fill escuelas
  const sel=document.getElementById('ev-escuela');
  sel.innerHTML='<option value="">Todas las escuelas</option>'+state.escuelas.map(e=>`<option value="${e.id}">${e.nombre}</option>`).join('');
  document.getElementById('modal-evento').classList.add('open');
  setTimeout(()=>document.getElementById('ev-titulo').focus(),100);
}
function saveEvento(){
  const titulo=document.getElementById('ev-titulo').value.trim();
  if(!titulo){showToast('‚ö†Ô∏è El t√≠tulo es obligatorio');return;}
  const tipo=document.getElementById('ev-tipo').value;
  const fecha=document.getElementById('ev-fecha').value;
  if(!fecha){showToast('‚ö†Ô∏è Seleccion√° una fecha');return;}
  const escuelaId=document.getElementById('ev-escuela').value?parseInt(document.getElementById('ev-escuela').value):null;
  const obs=document.getElementById('ev-obs').value.trim();
  const eid=parseInt(document.getElementById('edit-evento-id').value);
  if(eid){
    const ev=state.eventos.find(e=>e.id===eid);
    Object.assign(ev,{titulo,tipo,fecha,escuelaId,obs});
    showToast('‚úÖ Evento actualizado');
  } else {
    state.eventos.push({id:newId(),titulo,tipo,fecha,escuelaId,obs});
    showToast('‚úÖ Evento agregado');
  }
  closeModal('evento');saveLS();renderAll();
}
function editEvento(id){
  const e=state.eventos.find(x=>x.id===id);
  document.getElementById('modal-evento-title').textContent='Editar evento';
  document.getElementById('edit-evento-id').value=e.id;
  document.getElementById('ev-titulo').value=e.titulo;
  document.getElementById('ev-tipo').value=e.tipo;
  document.getElementById('ev-fecha').value=e.fecha;
  document.getElementById('ev-obs').value=e.obs||'';
  const sel=document.getElementById('ev-escuela');
  sel.innerHTML='<option value="">Todas las escuelas</option>'+state.escuelas.map(esc=>`<option value="${esc.id}">${esc.nombre}</option>`).join('');
  if(e.escuelaId)sel.value=e.escuelaId;
  document.getElementById('modal-evento').classList.add('open');
}
function deleteEvento(id){
  const e=state.eventos.find(x=>x.id===id);
  if(!confirm(`¬øEliminar "${e.titulo}"?`))return;
  state.eventos=state.eventos.filter(x=>x.id!==id);
  showToast('üóëÔ∏è Evento eliminado');saveLS();renderAll();
}

// NOTIFICACI√ìN AL ABRIR
function mostrarNotificacion(){
  const proximos=state.eventos.filter(e=>{
    const d=diasHasta(e.fecha);
    return d>=0&&d<=7;
  }).sort((a,b)=>a.fecha.localeCompare(b.fecha));

  if(!proximos.length)return; // no mostrar si no hay nada urgente

  const hoy=new Date();
  document.getElementById('notif-fecha-hoy').textContent=
    `${['Domingo','Lunes','Martes','Mi√©rcoles','Jueves','Viernes','S√°bado'][hoy.getDay()]} ${hoy.getDate()} de ${['enero','febrero','marzo','abril','mayo','junio','julio','agosto','septiembre','octubre','noviembre','diciembre'][hoy.getMonth()]}`;

  document.getElementById('notif-lista').innerHTML=proximos.map(e=>{
    const d=diasHasta(e.fecha);
    const cls=d===0?'hoy':d<=3?'pronto':'proximo';
    const badge=d===0?'¬°Hoy!':d===1?'Ma√±ana':`En ${d} d√≠as`;
    const badgeCls=d===0?'nb-hoy':d<=3?'nb-pronto':'nb-proximo';
    const esc=e.escuelaId?getEscuela(e.escuelaId):null;
    return`<div class="notif-item ${cls}">
      <span class="notif-badge ${badgeCls}">${badge}</span>
      <div>
        <div class="notif-ev-title">${e.titulo}</div>
        <div class="notif-ev-meta">${TIPO_LABEL[e.tipo]}${esc?' ¬∑ '+esc.nombre:' ¬∑ Todas las escuelas'} ¬∑ ${fmtFecha(e.fecha)}</div>
      </div>
    </div>`;
  }).join('');

  document.getElementById('notif-overlay').classList.add('open');
}
function cerrarNotif(){document.getElementById('notif-overlay').classList.remove('open');}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER ALL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderAll(){
  renderInicio();
  renderFiltroAlumnos();renderTablaAlumnos();
  renderFiltroAsist();
  renderFiltroHist();renderHistorial();
  renderFiltroSeg();
  renderCalendario();
  renderProximosInicio();
  renderEscuelas();
  renderNotasInicio();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LOCALSTORAGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const LS_KEY='profedesk_v15';
function saveLS(){
  const toSave={
    escuelas:state.escuelas,
    cursos:state.cursos,
    materias:state.materias,
    cursoMaterias:state.cursoMaterias,
    alumnos:state.alumnos,
    asistencia:state.asistencia,
    temas:state.temas,
    seguimiento:state.seguimiento,
    eventos:state.eventos,
    notas:state.notas,
    horario:state.horario,
    trayectoria:state.trayectoria,
    nextId:state.nextId,
  };
  try{localStorage.setItem(LS_KEY,JSON.stringify(toSave));}catch(e){}
}
function loadLS(){
  try{
    const raw=localStorage.getItem(LS_KEY);
    if(!raw)return false;
    const data=JSON.parse(raw);
    Object.assign(state,data);
    return true;
  }catch(e){return false;}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NOTAS CRUD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const NOTA_COLOR_LABEL={yellow:'üü° General',blue:'üîµ Pendiente',green:'üü¢ Resuelto',red:'üî¥ Urgente'};
function openModalNota(){
  document.getElementById('modal-nota-title').textContent='Nueva nota';
  document.getElementById('edit-nota-id').value='';
  document.getElementById('nota-titulo').value='';
  document.getElementById('nota-cuerpo').value='';
  document.getElementById('nota-color').value='yellow';
  const sel=document.getElementById('nota-escuela');
  sel.innerHTML='<option value="">Todas</option>'+state.escuelas.map(e=>`<option value="${e.id}">${e.nombre}</option>`).join('');
  document.getElementById('modal-nota').classList.add('open');
  setTimeout(()=>document.getElementById('nota-titulo').focus(),100);
}
function saveNota(){
  const titulo=document.getElementById('nota-titulo').value.trim();
  if(!titulo){showToast('‚ö†Ô∏è El t√≠tulo es obligatorio');return;}
  const cuerpo=document.getElementById('nota-cuerpo').value.trim();
  const color=document.getElementById('nota-color').value;
  const escuelaId=document.getElementById('nota-escuela').value?parseInt(document.getElementById('nota-escuela').value):null;
  const eid=parseInt(document.getElementById('edit-nota-id').value);
  const fecha=new Date().toISOString().slice(0,10);
  if(eid){
    const n=state.notas.find(n=>n.id===eid);
    Object.assign(n,{titulo,cuerpo,color,escuelaId});
    showToast('‚úÖ Nota actualizada');
  } else {
    state.notas.push({id:newId(),titulo,cuerpo,color,escuelaId,fecha});
    showToast('‚úÖ Nota agregada');
  }
  closeModal('nota');saveLS();renderAll();
}
function editNota(id){
  const n=state.notas.find(x=>x.id===id);
  document.getElementById('modal-nota-title').textContent='Editar nota';
  document.getElementById('edit-nota-id').value=n.id;
  document.getElementById('nota-titulo').value=n.titulo;
  document.getElementById('nota-cuerpo').value=n.cuerpo||'';
  document.getElementById('nota-color').value=n.color||'yellow';
  const sel=document.getElementById('nota-escuela');
  sel.innerHTML='<option value="">Todas</option>'+state.escuelas.map(e=>`<option value="${e.id}">${e.nombre}</option>`).join('');
  if(n.escuelaId)sel.value=n.escuelaId;
  document.getElementById('modal-nota').classList.add('open');
}
function deleteNota(id){
  if(!confirm('¬øEliminar esta nota?'))return;
  state.notas=state.notas.filter(n=>n.id!==id);
  showToast('üóëÔ∏è Nota eliminada');saveLS();renderAll();
}
function renderNotasInicio(){
  const el=document.getElementById('notas-lista-inicio');
  if(!el)return;
  if(!state.notas.length){
    el.innerHTML='<div style="color:var(--muted);font-size:.85rem;padding:.5rem 0;">No ten√©s notas a√∫n. ¬°Agreg√° la primera!</div>';
    return;
  }
  const sorted=[...state.notas].sort((a,b)=>b.id-a.id);
  el.innerHTML=`<div class="notas-grid">${sorted.map(n=>{
    const esc=n.escuelaId?getEscuela(n.escuelaId):null;
    return`<div class="nota-card nc-${n.color||'yellow'}">
      <div class="nota-card-titulo">${n.titulo}</div>
      ${n.cuerpo?`<div class="nota-card-cuerpo">${n.cuerpo}</div>`:''}
      <div class="nota-card-meta">
        <span>${esc?'üè´ '+esc.nombre:''} ${n.fecha?'¬∑ '+fmtFecha(n.fecha):''}</span>
        <div class="nota-card-actions">
          <button class="btn-icon" onclick="editNota(${n.id})">‚úèÔ∏è</button>
          <button class="btn-icon" onclick="deleteNota(${n.id})">üóëÔ∏è</button>
        </div>
      </div>
    </div>`;
  }).join('')}</div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EXPORTAR / IMPORTAR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function exportarDatos(){
  const datos={
    version:10,
    fecha:new Date().toISOString(),
    escuelas:state.escuelas,
    cursos:state.cursos,
    materias:state.materias,
    cursoMaterias:state.cursoMaterias,
    alumnos:state.alumnos,
    asistencia:state.asistencia,
    temas:state.temas,
    seguimiento:state.seguimiento,
    eventos:state.eventos,
    notas:state.notas,
    nextId:state.nextId,
  };
  const json=JSON.stringify(datos,null,2);
  const blob=new Blob([json],{type:'application/json'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  const hoy=new Date().toISOString().slice(0,10);
  a.download=`profedesk_backup_${hoy}.json`;
  a.click();
  URL.revokeObjectURL(a.href);
  showToast('‚¨áÔ∏è Datos exportados correctamente');
}

function importarDatos(event){
  const file=event.target.files[0];
  if(!file)return;
  const reader=new FileReader();
  reader.onload=function(e){
    try{
      const datos=JSON.parse(e.target.result);
      if(!datos.escuelas||!datos.alumnos){showToast('‚ö†Ô∏è Archivo inv√°lido');return;}
      if(!confirm(`¬øReemplazar todos los datos actuales con el backup del ${datos.fecha?datos.fecha.slice(0,10):'archivo seleccionado'}?\n\nEsto no se puede deshacer.`)){event.target.value='';return;}
      state.escuelas=datos.escuelas||[];
      state.cursos=datos.cursos||[];
      state.materias=datos.materias||[];
      state.cursoMaterias=datos.cursoMaterias||{};
      state.alumnos=datos.alumnos||[];
      state.asistencia=datos.asistencia||{};
      state.temas=datos.temas||{};
      state.seguimiento=datos.seguimiento||{};
      state.eventos=datos.eventos||[];
      state.notas=datos.notas||[];
      state.horario=datos.horario||[];
      state.trayectoria=datos.trayectoria||{};
      state.nextId=datos.nextId||200;
      saveLS();renderAll();
      showToast('‚úÖ Datos importados correctamente');
    }catch(err){showToast('‚ö†Ô∏è Error al leer el archivo');}
    event.target.value='';
  };
  reader.readAsText(file);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// IMPORTAR ALUMNOS CSV/XLSX
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let _importPreview=[];

function descargarPlantilla(){
  const escuelas=state.escuelas.map(e=>e.nombre).join(' / ');
  const cursos=state.cursos.map(c=>{const e=getEscuela(c.escuelaId);return`${c.nombre} (${e?e.nombre:''})`}).join(' / ');
  let csv=`Nombre,Escuela,Curso\n`;
  csv+=`"Garc√≠a, Luc√≠a","${state.escuelas[0]?.nombre||'Escuela San Mart√≠n'}","${state.cursos[0]?.nombre||'3¬∞B'}"\n`;
  csv+=`"Mart√≠nez, Rodrigo","${state.escuelas[0]?.nombre||'Escuela San Mart√≠n'}","${state.cursos[0]?.nombre||'3¬∞B'}"\n`;
  // instrucciones como comentario al pie
  csv+=`\n`;
  csv+=`"--- ESCUELAS DISPONIBLES: ${escuelas} ---","",""\n`;
  csv+=`"--- CURSOS DISPONIBLES: ${cursos} ---","",""\n`;
  descargar(csv,'plantilla_alumnos.csv');
  showToast('üìÑ Plantilla descargada');
}

function importarAlumnos(event){
  const file=event.target.files[0];
  if(!file)return;
  const ext=file.name.split('.').pop().toLowerCase();
  if(ext==='csv'||ext==='txt'){
    const reader=new FileReader();
    reader.onload=e=>procesarCSVAlumnos(e.target.result);
    reader.readAsText(file,'UTF-8');
  } else if(ext==='xlsx'||ext==='xls'){
    const reader=new FileReader();
    reader.onload=e=>procesarXLSXAlumnos(e.target.result);
    reader.readAsArrayBuffer(file);
  } else {
    showToast('‚ö†Ô∏è Formato no soportado. Us√° .csv o .xlsx');
  }
  event.target.value='';
}

function procesarCSVAlumnos(text){
  // Detectar separador
  const sep=text.includes(';')?';':',';
  const lines=text.split(/\r?\n/).filter(l=>l.trim()&&!l.startsWith('---')&&!l.startsWith('"---'));
  if(lines.length<2){showToast('‚ö†Ô∏è El archivo est√° vac√≠o o tiene formato incorrecto');return;}
  // Saltear encabezado
  const rows=lines.slice(1).map(l=>{
    // Parseo simple respetando comillas
    const cols=[];
    let cur='',inQ=false;
    for(const ch of l){
      if(ch==='"'){inQ=!inQ;}
      else if(ch===sep&&!inQ){cols.push(cur.trim());cur='';}
      else cur+=ch;
    }
    cols.push(cur.trim());
    return cols;
  }).filter(r=>r[0]);
  mostrarPreviewImport(rows);
}

function procesarXLSXAlumnos(buffer){
  // Usar SheetJS si est√° disponible, sino avisar
  try{
    // SheetJS no est√° cargado en la app ‚Äî convertir a CSV manualmente no es posible
    // Instruimos al usuario a guardar como CSV
    showToast('‚ö†Ô∏è Para Excel guard√° el archivo como CSV primero (Archivo ‚Üí Guardar como ‚Üí CSV)');
  }catch(e){
    showToast('‚ö†Ô∏è Error al leer el Excel. Guard√° como CSV e intent√° de nuevo.');
  }
}

function mostrarPreviewImport(rows){
  _importPreview=[];
  const errores=[];

  const preview=rows.map((r,i)=>{
    const nombre=(r[0]||'').replace(/^"|"$/g,'').trim();
    const escNombre=(r[1]||'').replace(/^"|"$/g,'').trim();
    const curNombre=(r[2]||'').replace(/^"|"$/g,'').trim();
    if(!nombre){errores.push(`Fila ${i+2}: nombre vac√≠o`);return null;}

    // Buscar escuela (match flexible)
    const esc=state.escuelas.find(e=>e.nombre.toLowerCase()===escNombre.toLowerCase())||
               state.escuelas.find(e=>e.nombre.toLowerCase().includes(escNombre.toLowerCase()));
    // Buscar curso dentro de la escuela
    const cur=esc?state.cursos.find(c=>c.escuelaId===esc.id&&c.nombre.toLowerCase()===curNombre.toLowerCase()):null;

    const ok=!!(esc&&cur);
    if(!ok){
      if(!esc)errores.push(`Fila ${i+2} "${nombre}": escuela "${escNombre}" no encontrada`);
      else if(!cur)errores.push(`Fila ${i+2} "${nombre}": curso "${curNombre}" no encontrado en ${esc.nombre}`);
    }

    const entry={nombre,escNombre,curNombre,escId:esc?.id,curId:cur?.id,ok};
    if(ok)_importPreview.push(entry);
    return entry;
  }).filter(Boolean);

  // Mostrar tabla preview
  const wrap=document.getElementById('import-preview-wrap');
  const okCount=preview.filter(r=>r.ok).length;
  document.getElementById('import-preview-info').innerHTML=
    `<strong>${preview.length}</strong> filas encontradas ¬∑ <span style="color:var(--sage);font-weight:700;">${okCount} v√°lidas</span>${errores.length?` ¬∑ <span style="color:var(--accent);font-weight:700;">${errores.length} con problema</span>`:''}`;

  wrap.innerHTML=`<table><thead><tr><th>Nombre</th><th>Escuela</th><th>Curso</th><th>Estado</th></tr></thead><tbody>
  ${preview.map(r=>`<tr style="opacity:${r.ok?1:.5}">
    <td>${r.nombre}</td>
    <td style="font-size:.78rem;">${r.escNombre}</td>
    <td style="font-size:.78rem;">${r.curNombre}</td>
    <td>${r.ok?'<span style="color:var(--sage);font-weight:700;">‚úì</span>':'<span style="color:var(--accent);font-weight:700;">‚úó</span>'}</td>
  </tr>`).join('')}
  </tbody></table>`;

  // Errores
  const errDiv=document.getElementById('import-errores');
  if(errores.length){
    errDiv.style.display='block';
    errDiv.innerHTML='<strong>Problemas encontrados:</strong><br>'+errores.map(e=>`¬∑ ${e}`).join('<br>');
  } else {
    errDiv.style.display='none';
  }

  document.getElementById('btn-confirmar-import').textContent=`‚úÖ Importar ${okCount} alumnos`;
  document.getElementById('btn-confirmar-import').disabled=okCount===0;
  document.getElementById('modal-import-alumnos').classList.add('open');
}

function confirmarImportAlumnos(){
  if(!_importPreview.length)return;
  let agregados=0,omitidos=0;
  _importPreview.forEach(r=>{
    // Evitar duplicados por nombre+curso
    const existe=state.alumnos.find(a=>a.nombre.toLowerCase()===r.nombre.toLowerCase()&&a.cursoId===r.curId);
    if(existe){omitidos++;return;}
    state.alumnos.push({id:newId(),nombre:r.nombre,cursoId:r.curId,notas:{}});
    agregados++;
  });
  saveLS();renderAll();
  closeModal('import-alumnos');
  _importPreview=[];
  showToast(`‚úÖ ${agregados} alumnos importados${omitidos?` ¬∑ ${omitidos} ya exist√≠an`:''}`);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TEMA DE CLASE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getTemaKey(){
  const cursoId=document.getElementById('asist-curso')?.value;
  const materiaId=document.getElementById('asist-materia')?.value;
  const fecha=document.getElementById('asist-fecha')?.value;
  if(!cursoId||!materiaId||!fecha)return null;
  return`${cursoId}_${materiaId}_${fecha}`;
}
function getTemaKeySeg(){
  const cursoId=document.getElementById('seg-curso')?.value;
  const materiaId=document.getElementById('seg-materia')?.value;
  const fecha=document.getElementById('seg-fecha')?.value;
  if(!cursoId||!materiaId||!fecha)return null;
  return`${cursoId}_${materiaId}_${fecha}`;
}
function cargarTema(){
  const key=getTemaKey();
  const t=key&&state.temas[key]||{};
  const ti=document.getElementById('asist-tema-titulo');
  const td=document.getElementById('asist-tema-desc');
  if(ti)ti.value=t.titulo||'';
  if(td)td.value=t.descripcion||'';
}
function cargarTemaSeg(){
  const key=getTemaKeySeg();
  const t=key&&state.temas[key]||{};
  const ti=document.getElementById('seg-tema-titulo');
  const td=document.getElementById('seg-tema-desc');
  if(ti)ti.value=t.titulo||'';
  if(td)td.value=t.descripcion||'';
}
let _temaTimer=null;
function guardarTemaAuto(){
  clearTimeout(_temaTimer);
  _temaTimer=setTimeout(()=>{
    const key=getTemaKey();
    if(!key)return;
    if(!state.temas[key])state.temas[key]={};
    state.temas[key].titulo=document.getElementById('asist-tema-titulo').value.trim();
    state.temas[key].descripcion=document.getElementById('asist-tema-desc').value.trim();
    saveLS();
  },600);
}
let _temaSegTimer=null;
function guardarTemaSegAuto(){
  clearTimeout(_temaSegTimer);
  _temaSegTimer=setTimeout(()=>{
    const key=getTemaKeySeg();
    if(!key)return;
    if(!state.temas[key])state.temas[key]={};
    state.temas[key].titulo=document.getElementById('seg-tema-titulo').value.trim();
    state.temas[key].descripcion=document.getElementById('seg-tema-desc').value.trim();
    saveLS();
  },600);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const _d=new Date();
const _dias=['Dom','Lun','Mar','Mi√©','Jue','Vie','S√°b'];
const _mes=['ene','feb','mar','abr','may','jun','jul','ago','sep','oct','nov','dic'];
document.getElementById('fecha-live').textContent=`${_dias[_d.getDay()]} ${_d.getDate()} ${_mes[_d.getMonth()]} ${_d.getFullYear()}`;
document.getElementById('asist-fecha').value=_d.toISOString().slice(0,10);

// Migraci√≥n: si no hay datos en v15 pero s√≠ en una clave vieja, migrarlos
(function migrateLS(){
  if(localStorage.getItem(LS_KEY))return; // ya tiene datos nuevos
  const oldKeys=['profedesk_v6','profedesk_v8','profedesk_v10','profedesk_v11','profedesk_v12','profedesk_v13','profedesk_v14'];
  for(const k of oldKeys){
    const raw=localStorage.getItem(k);
    if(raw){
      localStorage.setItem(LS_KEY,raw);
      showToast('‚úÖ Datos migrados correctamente');
      break;
    }
  }
})();

// Cargar desde localStorage (sobreescribe demos si hay datos guardados)
const _hasSaved=loadLS();

['modal-alumno','modal-escuela','modal-curso','modal-seguimiento','modal-evento','modal-nota','modal-materia','modal-import-alumnos','modal-clase','modal-interv','modal-drive-setup'].forEach(id=>{
  const el=document.getElementById(id);
  if(el)el.addEventListener('click',e=>{if(e.target.id===id)closeModal(id.replace('modal-',''));});
});

document.getElementById('seg-fecha').value=_d.toISOString().slice(0,10);

// Mostrar notificaci√≥n al abrir (con peque√±o delay para que cargue la UI)
setTimeout(mostrarNotificacion, 600);

renderAll();
if(_hasSaved)showToast('‚úÖ Datos cargados autom√°ticamente');

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GOOGLE DRIVE SYNC
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const DRIVE_LS_KEY   = 'profedesk_drive_clientid';
const DRIVE_FILE_KEY = 'profedesk_drive_fileid';
const DRIVE_FILE_NAME = 'profedesk_datos.json';
const DRIVE_SCOPES = 'https://www.googleapis.com/auth/drive.appdata https://www.googleapis.com/auth/drive.file';

let gDrive = {
  clientId: localStorage.getItem(DRIVE_LS_KEY) || '',
  fileId:   localStorage.getItem(DRIVE_FILE_KEY) || null,
  accessToken: null,
  userEmail: null,
  tokenClient: null,
  ready: false,
};

// ‚îÄ‚îÄ UI helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function driveSetUI(status, label, lastSync) {
  const dot  = document.getElementById('drive-dot');
  const user = document.getElementById('drive-user');
  const last = document.getElementById('drive-last');
  const btnLogin  = document.getElementById('btn-drive-login');
  const btnSync   = document.getElementById('btn-drive-sync');
  const btnLogout = document.getElementById('btn-drive-logout');

  dot.className  = 'drive-status-dot';
  if (status === 'ok')      { dot.classList.add('ds-ok');      }
  else if (status === 'syncing') { dot.classList.add('ds-syncing'); }
  else if (status === 'error')   { dot.classList.add('ds-error');   }
  else                           { dot.classList.add('ds-off');     }

  user.textContent = label || 'Sin conectar';
  last.textContent = lastSync ? '¬∑ ' + lastSync : '';

  const connected = status === 'ok' || status === 'syncing';
  btnLogin.style.display  = connected ? 'none'  : 'inline-flex';
  btnSync.style.display   = connected ? 'inline-flex' : 'none';
  btnLogout.style.display = connected ? 'inline-flex' : 'none';
}

// ‚îÄ‚îÄ Inicializar Google Identity ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function driveInit() {
  if (!gDrive.clientId) return;
  if (typeof google === 'undefined') {
    setTimeout(driveInit, 500); return;
  }
  gDrive.tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: gDrive.clientId,
    scope: DRIVE_SCOPES,
    callback: async (resp) => {
      if (resp.error) { driveSetUI('error', 'Error de acceso'); showToast('‚ö†Ô∏è Error Google: ' + resp.error); return; }
      gDrive.accessToken = resp.access_token;
      gDrive.ready = true;
      await driveGetUserInfo();
      await driveLoadOrCreate();
    },
  });
  gDrive.ready = false;
}

async function driveGetUserInfo() {
  try {
    const r = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', {
      headers: { Authorization: 'Bearer ' + gDrive.accessToken }
    });
    const info = await r.json();
    gDrive.userEmail = info.email || info.name || 'Conectado';
  } catch(e) { gDrive.userEmail = 'Conectado'; }
}

// ‚îÄ‚îÄ Login / Logout ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function driveLogin() {
  if (!gDrive.clientId) {
    openModal('drive-setup');
    document.getElementById('drive-client-id-input').value = gDrive.clientId;
    return;
  }
  if (!gDrive.tokenClient) { driveInit(); setTimeout(driveLogin, 600); return; }
  gDrive.tokenClient.requestAccessToken({ prompt: 'consent' });
  driveSetUI('syncing', 'Conectando‚Ä¶');
}

function driveLogout() {
  if (gDrive.accessToken) google.accounts.oauth2.revoke(gDrive.accessToken);
  gDrive.accessToken = null;
  gDrive.ready = false;
  gDrive.userEmail = null;
  driveSetUI('off', 'Sin conectar');
  showToast('‚òÅÔ∏è Drive desconectado');
}

function saveClientId() {
  const val = document.getElementById('drive-client-id-input').value.trim();
  if (!val || !val.includes('.apps.googleusercontent.com')) {
    showToast('‚ö†Ô∏è Client ID inv√°lido. Debe terminar en .apps.googleusercontent.com'); return;
  }
  gDrive.clientId = val;
  localStorage.setItem(DRIVE_LS_KEY, val);
  closeModal('drive-setup');
  driveInit();
  setTimeout(driveLogin, 400);
  showToast('‚úÖ Client ID guardado');
}

// ‚îÄ‚îÄ Buscar o crear archivo en Drive ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function driveFindFile() {
  // Buscar en appDataFolder primero
  const q = encodeURIComponent(`name='${DRIVE_FILE_NAME}' and trashed=false`);
  const r = await fetch(
    `https://www.googleapis.com/drive/v3/files?spaces=appDataFolder&q=${q}&fields=files(id,name,modifiedTime)`,
    { headers: { Authorization: 'Bearer ' + gDrive.accessToken } }
  );
  const data = await r.json();
  if (data.files && data.files.length) return data.files[0].id;

  // Tambi√©n buscar en Drive ra√≠z
  const r2 = await fetch(
    `https://www.googleapis.com/drive/v3/files?q=${q}&fields=files(id,name,modifiedTime)`,
    { headers: { Authorization: 'Bearer ' + gDrive.accessToken } }
  );
  const data2 = await r2.json();
  if (data2.files && data2.files.length) return data2.files[0].id;

  return null;
}

async function driveCreateFile(jsonStr) {
  const metadata = { name: DRIVE_FILE_NAME, mimeType: 'application/json', parents: ['appDataFolder'] };
  const form = new FormData();
  form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
  form.append('file', new Blob([jsonStr], { type: 'application/json' }));
  const r = await fetch(
    'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id',
    { method: 'POST', headers: { Authorization: 'Bearer ' + gDrive.accessToken }, body: form }
  );
  const d = await r.json();
  return d.id;
}

async function driveUpdateFile(fileId, jsonStr) {
  await fetch(
    `https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`,
    { method: 'PATCH', headers: { Authorization: 'Bearer ' + gDrive.accessToken, 'Content-Type': 'application/json' }, body: jsonStr }
  );
}

async function driveReadFile(fileId) {
  const r = await fetch(
    `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`,
    { headers: { Authorization: 'Bearer ' + gDrive.accessToken } }
  );
  return await r.json();
}

// ‚îÄ‚îÄ Cargar o crear al conectar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function driveLoadOrCreate() {
  driveSetUI('syncing', gDrive.userEmail, 'cargando‚Ä¶');
  try {
    let fileId = gDrive.fileId || await driveFindFile();

    if (fileId) {
      gDrive.fileId = fileId;
      localStorage.setItem(DRIVE_FILE_KEY, fileId);
      // Leer datos remotos
      const remoteData = await driveReadFile(fileId);
      if (remoteData && remoteData.escuelas) {
        // Comparar con local: usar el m√°s reciente
        const localNextId = state.nextId || 0;
        const remoteNextId = remoteData.nextId || 0;
        if (remoteNextId >= localNextId) {
          // Drive tiene datos m√°s recientes o igual ‚Äî preguntar
          const localItems = state.alumnos.length + state.eventos.length;
          const remoteItems = (remoteData.alumnos||[]).length + (remoteData.eventos||[]).length;
          if (remoteItems > 0 && localItems > 0 && remoteNextId !== localNextId) {
            const useRemote = confirm(
              `‚òÅÔ∏è Se encontraron datos en Drive (${remoteItems} registros).
` +
              `üì± Este dispositivo tiene ${localItems} registros.

` +
              `¬øUsar los datos de Drive? (Cancelar = subir datos locales a Drive)`
            );
            if (useRemote) {
              applyRemoteData(remoteData);
            } else {
              await drivePush();
            }
          } else if (remoteItems > 0 && localItems === 0) {
            applyRemoteData(remoteData);
          } else {
            await drivePush();
          }
        } else {
          await drivePush();
        }
      } else {
        await drivePush(); // archivo vac√≠o, subir datos locales
      }
    } else {
      // No existe ‚Äî crear con datos locales
      const json = buildSaveJson();
      fileId = await driveCreateFile(json);
      gDrive.fileId = fileId;
      localStorage.setItem(DRIVE_FILE_KEY, fileId);
      showToast('‚òÅÔ∏è Archivo creado en Drive');
    }

    const now = new Date().toLocaleTimeString('es-AR',{hour:'2-digit',minute:'2-digit'});
    driveSetUI('ok', gDrive.userEmail, 'sincronizado ' + now);
  } catch(e) {
    console.error('Drive error:', e);
    driveSetUI('error', 'Error de sync');
    showToast('‚ö†Ô∏è Error al conectar con Drive: ' + e.message);
  }
}

function applyRemoteData(data) {
  state.escuelas    = data.escuelas    || state.escuelas;
  state.cursos      = data.cursos      || state.cursos;
  state.materias    = data.materias    || state.materias;
  state.cursoMaterias = data.cursoMaterias || state.cursoMaterias;
  state.alumnos     = data.alumnos     || state.alumnos;
  state.asistencia  = data.asistencia  || state.asistencia;
  state.temas       = data.temas       || state.temas;
  state.seguimiento = data.seguimiento || state.seguimiento;
  state.eventos     = data.eventos     || state.eventos;
  state.notas       = data.notas       || state.notas;
  state.horario     = data.horario     || state.horario;
  state.trayectoria = data.trayectoria || state.trayectoria;
  state.nextId      = data.nextId      || state.nextId;
  saveLS();
  renderAll();
  showToast('‚òÅÔ∏è Datos cargados desde Drive');
}

// ‚îÄ‚îÄ Push: subir datos a Drive ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function drivePush() {
  if (!gDrive.ready || !gDrive.accessToken) return;
  const json = buildSaveJson();
  if (gDrive.fileId) {
    await driveUpdateFile(gDrive.fileId, json);
  } else {
    const id = await driveCreateFile(json);
    gDrive.fileId = id;
    localStorage.setItem(DRIVE_FILE_KEY, id);
  }
  const now = new Date().toLocaleTimeString('es-AR',{hour:'2-digit',minute:'2-digit'});
  driveSetUI('ok', gDrive.userEmail, 'guardado ' + now);
}

function buildSaveJson() {
  return JSON.stringify({
    version: 14,
    fecha: new Date().toISOString(),
    escuelas:     state.escuelas,
    cursos:       state.cursos,
    materias:     state.materias,
    cursoMaterias: state.cursoMaterias,
    alumnos:      state.alumnos,
    asistencia:   state.asistencia,
    temas:        state.temas,
    seguimiento:  state.seguimiento,
    eventos:      state.eventos,
    notas:        state.notas,
    horario:      state.horario,
    trayectoria:  state.trayectoria,
    nextId:       state.nextId,
  }, null, 2);
}

// ‚îÄ‚îÄ Sync manual (bot√≥n header) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function driveSync() {
  if (!gDrive.ready) { showToast('‚ö†Ô∏è Primero conectate a Drive'); return; }
  driveSetUI('syncing', gDrive.userEmail, 'guardando‚Ä¶');
  try {
    await drivePush();
    showToast('‚òÅÔ∏è Sincronizado con Drive');
  } catch(e) {
    driveSetUI('error', gDrive.userEmail);
    showToast('‚ö†Ô∏è Error al sincronizar: ' + e.message);
  }
}

// ‚îÄ‚îÄ Auto-sync: interceptar saveLS para tambi√©n subir a Drive ‚îÄ‚îÄ
const _originalSaveLS = saveLS;
function saveLS() {
  _originalSaveLS();
  if (gDrive.ready && gDrive.accessToken) {
    driveSetUI('syncing', gDrive.userEmail, 'guardando‚Ä¶');
    drivePush().catch(() => driveSetUI('error', gDrive.userEmail));
  }
}

// ‚îÄ‚îÄ Agregar modal-drive-setup a la lista de modales ‚îÄ‚îÄ
// modal-drive-setup listener handled above

// ‚îÄ‚îÄ Init al cargar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
if (gDrive.clientId) {
  setTimeout(driveInit, 800);
}


// HORARIO
const DIAS_H=["Lunes","Martes","Miercoles","Jueves","Viernes"];
const DIAS_C=["Lun","Mar","Mie","Jue","Vie"];
const TURNO_LIST=[
  {key:"manana",label:"Manana",cls:"t-manana"},
  {key:"tarde", label:"Tarde", cls:"t-tarde"},
  {key:"noche", label:"Noche", cls:"t-noche"},
];
const TURNO_ICONS={manana:"AM",tarde:"PM",noche:"NP"};
const TURNO_EMOJIS={manana:"Manana",tarde:"Tarde",noche:"Noche"};
const CCOLORS={
  sage:  {bg:"rgba(74,124,89,.18)", txt:"#2d5e38",br:"#4a7c59"},
  accent:{bg:"rgba(192,57,43,.15)",txt:"#8b1e10",br:"#c0392b"},
  gold:  {bg:"rgba(212,160,23,.2)",txt:"#7a5800",br:"#d4a017"},
  blue:  {bg:"rgba(36,113,163,.15)",txt:"#154360",br:"#2471a3"},
  purple:{bg:"rgba(125,60,152,.15)",txt:"#4a235a",br:"#7d3c98"},
};

let vistaHorario="semana";
let diaSelH=(function(){var d=new Date().getDay();return(d===0||d===6)?0:d-1;})();

function setVistaHorario(v){
  vistaHorario=v;
  document.getElementById("btn-vista-semana").classList.toggle("active",v==="semana");
  document.getElementById("btn-vista-dia").classList.toggle("active",v==="dia");
  document.getElementById("horario-semana").style.display=v==="semana"?"block":"none";
  document.getElementById("horario-dia").style.display=v==="dia"?"block":"none";
  renderHorario();
}
function renderHorario(){
  if(vistaHorario==="semana")renderHorarioSemana();
  else renderHorarioDia();
}

function renderHorarioSemana(){
  var hoy=new Date().getDay()-1;
  var h="<div class=\"hg-header\" style=\"background:transparent;\"></div>";
  for(var i=0;i<5;i++){
    h+="<div class=\"hg-header"+(i===hoy?" dia-hoy":"")+"\">"+DIAS_C[i]+"</div>";
  }
  for(var ti=0;ti<TURNO_LIST.length;ti++){
    var tur=TURNO_LIST[ti];
    if(ti>0)h+="<div class=\"hg-sep\"></div>";
    h+="<div class=\"hg-turno-label "+tur.cls+"\">"+tur.label+"</div>";
    for(var dia=0;dia<5;dia++){
      var clases=state.horario.filter(function(cl){return cl.dia===dia&&cl.turno===tur.key;});
      clases.sort(function(a,b){return(a.inicio||"").localeCompare(b.inicio||"");});
      h+="<div class=\"hg-slot "+tur.cls+"\" onclick=\"abrirSlot("+dia+",'"+tur.key+"')\">";
      if(clases.length){
        clases.forEach(function(cl){
          var col=CCOLORS[cl.color]||CCOLORS.sage;
          h+="<div class=\"hg-clase\" style=\"background:"+col.bg+";color:"+col.txt+";border-left:3px solid "+col.br+";\" onclick=\"event.stopPropagation();editClase("+cl.id+")\">";
          h+="<div class=\"hc-nombre\">"+cl.nombre+"</div>";
          h+="<div class=\"hc-meta\">"+(cl.inicio?cl.inicio+" - "+cl.fin:"")+"</div></div>";
        });
        h+="<button class=\"hg-add-btn\" style=\"height:18px;opacity:.4;\" onclick=\"event.stopPropagation();abrirSlot("+dia+",'"+tur.key+"')\">&plus;</button>";
      } else {
        h+="<button class=\"hg-add-btn\" onclick=\"event.stopPropagation();abrirSlot("+dia+",'"+tur.key+"')\">&plus;</button>";
      }
      h+="</div>";
    }
  }
  document.getElementById("horario-grid").innerHTML=h;
}

function diaNav(dir){diaSelH=(diaSelH+dir+5)%5;renderHorarioDia();}

function renderHorarioDia(){
  document.getElementById("dia-nombre-label").textContent=DIAS_H[diaSelH];
  var totalC=state.horario.filter(function(cl){return cl.dia===diaSelH;}).length;
  if(totalC===0){
    document.getElementById("horario-dia-content").innerHTML="<div class=\"empty-state\"><div class=\"big\">Libre</div><div>Sin clases este dia</div></div>";
    return;
  }
  var h="";
  TURNO_LIST.forEach(function(tur){
    var clases=state.horario.filter(function(cl){return cl.dia===diaSelH&&cl.turno===tur.key;});
    clases.sort(function(a,b){return(a.inicio||"").localeCompare(b.inicio||"");});
    h+="<div class=\"turno-section\"><div class=\"turno-header "+tur.cls+"\">"+tur.label+"</div><div class=\"turno-clases\">";
    if(!clases.length){
      h+="<div class=\"empty-turno\">Libre</div>";
    } else {
      clases.forEach(function(cl){
        var col=CCOLORS[cl.color]||CCOLORS.sage;
        var esc=getEscuela(cl.escuelaId);
        var cur=getCurso(cl.cursoId);
        h+="<div class=\"clase-card\" style=\"border-left-color:"+col.br+";\">";
        h+="<div class=\"clase-hora\">"+(cl.inicio||"--:--")+"<br>a<br>"+(cl.fin||"--:--")+"</div>";
        h+="<div class=\"clase-info\">";
        h+="<div class=\"clase-nombre\">"+cl.nombre+"</div>";
        h+="<div class=\"clase-meta\">";
        if(esc)h+="<span class=\"clase-escuela-badge\" style=\"background:"+col.br+"\">"+esc.nombre+"</span> ";
        if(cur)h+=cur.nombre;
        h+="</div></div>";
        h+="<div class=\"clase-acciones\">";
        h+="<button class=\"btn-icon\" onclick=\"editClase("+cl.id+")\">Edit</button>";
        h+="<button class=\"btn-icon\" onclick=\"deleteClase("+cl.id+")\">Del</button>";
        h+="</div></div>";
      });
    }
    h+="</div></div>";
  });
  document.getElementById("horario-dia-content").innerHTML=h;
}

function abrirSlot(dia,turno){
  document.getElementById("modal-clase-title").textContent="Nueva clase";
  document.getElementById("edit-clase-id").value="";
  document.getElementById("edit-clase-dia").value=dia;
  document.getElementById("edit-clase-turno").value=turno;
  document.getElementById("clase-nombre").value="";
  document.getElementById("clase-inicio").value="";
  document.getElementById("clase-fin").value="";
  document.getElementById("clase-color").value="sage";
  document.getElementById("clase-dia").value=dia;
  document.getElementById("clase-turno").value=turno;
  fillEscuelasSelect("clase-escuela");
  updateCursosSelect("clase-escuela","clase-curso-h");
  document.getElementById("btn-delete-clase").style.display="none";
  document.getElementById("modal-clase").classList.add("open");
  setTimeout(function(){document.getElementById("clase-nombre").focus();},100);
}

function editClase(id){
  var cl=state.horario.find(function(x){return x.id===id;});
  if(!cl)return;
  document.getElementById("modal-clase-title").textContent="Editar clase";
  document.getElementById("edit-clase-id").value=cl.id;
  document.getElementById("clase-nombre").value=cl.nombre;
  document.getElementById("clase-dia").value=cl.dia;
  document.getElementById("clase-turno").value=cl.turno;
  document.getElementById("clase-inicio").value=cl.inicio||"";
  document.getElementById("clase-fin").value=cl.fin||"";
  document.getElementById("clase-color").value=cl.color||"sage";
  fillEscuelasSelect("clase-escuela");
  if(cl.escuelaId)document.getElementById("clase-escuela").value=cl.escuelaId;
  updateCursosSelect("clase-escuela","clase-curso-h");
  if(cl.cursoId)document.getElementById("clase-curso-h").value=cl.cursoId;
  document.getElementById("btn-delete-clase").style.display="inline-flex";
  document.getElementById("modal-clase").classList.add("open");
}

function saveClase(){
  var nombre=document.getElementById("clase-nombre").value.trim();
  if(!nombre){showToast("El nombre es obligatorio");return;}
  var dia=parseInt(document.getElementById("clase-dia").value);
  var turno=document.getElementById("clase-turno").value;
  var inicio=document.getElementById("clase-inicio").value;
  var fin=document.getElementById("clase-fin").value;
  var color=document.getElementById("clase-color").value;
  var escuelaId=document.getElementById("clase-escuela").value?parseInt(document.getElementById("clase-escuela").value):null;
  var cursoId=document.getElementById("clase-curso-h").value?parseInt(document.getElementById("clase-curso-h").value):null;
  var eid=parseInt(document.getElementById("edit-clase-id").value);
  if(eid){
    var cl=state.horario.find(function(x){return x.id===eid;});
    Object.assign(cl,{nombre,dia,turno,inicio,fin,color,escuelaId,cursoId});
    showToast("Clase actualizada");
  } else {
    state.horario.push({id:newId(),nombre,dia,turno,inicio,fin,color,escuelaId,cursoId});
    showToast("Clase agregada");
  }
  closeModal("clase");saveLS();renderHorario();
}

function deleteClaseActual(){
  var eid=parseInt(document.getElementById("edit-clase-id").value);
  if(!eid)return;
  if(!confirm("Eliminar esta clase del horario?"))return;
  state.horario=state.horario.filter(function(x){return x.id!==eid;});
  showToast("Clase eliminada");
  closeModal("clase");saveLS();renderHorario();
}

function deleteClase(id){
  if(!confirm("Eliminar esta clase?"))return;
  state.horario=state.horario.filter(function(x){return x.id!==id;});
  showToast("Clase eliminada");saveLS();renderHorario();
}


// TRAYECTORIA
let trayAlumnoId=null;
let trayTabActual='resumen';
const TIPO_INTERV={reunion:{label:'Reunion con padres',color:'#4a7c59'},derivacion:{label:'Derivacion',color:'#2471a3'},llamado:{label:'Llamado telefonico',color:'#d4a017'},acuerdo:{label:'Acuerdo pedagogico',color:'#7d3c98'},otro:{label:'Otro',color:'#888'}};
const SIT_LABELS={nuevo:'Alumno nuevo',repitente:'Repitente',pase:'Pase',reincorporado:'Reincorporado','':`Sin especificar`};
const SIT_CLS={nuevo:'ib-nuevo',repitente:'ib-repitente',pase:'ib-pase',reincorporado:'ib-reincorporado','':`ib-nuevo`};
const COND_LABELS={regular:'Regular',libre:'Libre',condicional:'Condicional','':`Sin especificar`};

function getTray(id){
  if(!state.trayectoria[id])state.trayectoria[id]={situacion:'',anioIngreso:'',escuelaOrigen:'',condicion:'',contexto:'',observaciones:'',obsActualizada:'',intervenciones:[]};
  return state.trayectoria[id];
}

function abrirTrayectoria(alumnoId){
  trayAlumnoId=alumnoId;
  trayTabActual='resumen';
  const al=state.alumnos.find(function(a){return a.id===alumnoId;});
  if(!al)return;
  const cur=getCurso(al.cursoId);
  const esc=cur?getEscuela(cur.escuelaId):null;
  const col=esc?getColor(esc.id):'#888';
  document.getElementById('tray-avatar').style.background=col;
  document.getElementById('tray-avatar').textContent=initials(al.nombre);
  document.getElementById('tray-nombre').textContent=al.nombre;
  document.getElementById('tray-sub').textContent=(esc?esc.nombre:'')+(cur?' - '+cur.nombre:'');
  document.getElementById('tray-overlay').classList.add('open');
  document.querySelectorAll('.tray-tab').forEach(function(t,i){t.classList.toggle('active',i===0);});
  renderTrayTab('resumen');
}

function cerrarTrayectoria(){
  document.getElementById('tray-overlay').classList.remove('open');
  trayAlumnoId=null;
}

function trayTab(tab,el){
  trayTabActual=tab;
  document.querySelectorAll('.tray-tab').forEach(function(t){t.classList.remove('active');});
  el.classList.add('active');
  renderTrayTab(tab);
}

function renderTrayTab(tab){
  ['resumen','ingreso','observaciones','intervenciones'].forEach(function(t){
    document.getElementById('tray-'+t).style.display=t===tab?'block':'none';
  });
  if(tab==='resumen')renderTrayResumen();
  else if(tab==='ingreso')renderTrayIngreso();
  else if(tab==='observaciones')renderTrayObs();
  else if(tab==='intervenciones')renderTrayIntervenciones();
}

function renderTrayResumen(){
  const al=state.alumnos.find(function(a){return a.id===trayAlumnoId;});
  const tr=getTray(trayAlumnoId);
  const cur=getCurso(al.cursoId);
  // Asistencia
  const entries=Object.entries(state.asistencia).filter(function(e){return e[0].startsWith(cur?cur.id+'_':'NONE');});
  const total=entries.length;
  const pres=entries.filter(function(e){return e[1][al.id]&&e[1][al.id].estado==='P';}).length;
  const ause=entries.filter(function(e){return e[1][al.id]&&e[1][al.id].estado==='A';}).length;
  const pct=total?Math.round(pres/total*100):null;
  // Stats
  document.getElementById('tray-stats-row').innerHTML=
    '<div class="tray-stat"><div class="tray-stat-val" style="color:var(--sage)">'+(pct!==null?pct+'%':'‚Äî')+'</div><div class="tray-stat-lbl">Asistencia</div></div>'+
    '<div class="tray-stat"><div class="tray-stat-val" style="color:var(--accent)">'+ause+'</div><div class="tray-stat-lbl">Ausencias</div></div>'+
    '<div class="tray-stat"><div class="tray-stat-val">'+tr.intervenciones.length+'</div><div class="tray-stat-lbl">Intervenciones</div></div>';
  // Notas por materia
  const mats=cur?getMateriasDelCurso(cur.id):[];
  let notasHtml='';
  if(mats.length){
    notasHtml='<div style="margin-bottom:1rem;"><div class="ing-label" style="margin-bottom:.5rem;">Notas por materia</div>';
    mats.forEach(function(m){
      const n=al.notas&&al.notas[m.id]||{};
      const p=promedio(al,m.id);
      notasHtml+='<div style="display:flex;align-items:center;gap:.5rem;padding:.4rem 0;border-bottom:1px solid var(--border);font-size:.84rem;">';
      notasHtml+='<span style="flex:1;font-weight:600;">'+m.nombre+'</span>';
      ['t1','t2','t3'].forEach(function(t){notasHtml+=n[t]!=null?'<span class="nota-badge '+notaClass(n[t])+'">'+n[t]+'</span>':'<span style="color:var(--border);font-size:.75rem;">‚Äî</span>';});
      if(p)notasHtml+='<span style="font-weight:700;color:var(--ink);font-size:.88rem;">= '+p+'</span>';
      notasHtml+='</div>';
    });
    notasHtml+='</div>';
  }
  document.getElementById('tray-resumen-notas').innerHTML=notasHtml;
  // Ingreso resumen
  var ingHtml='<div class="ing-label" style="margin-bottom:.4rem;">Trayectoria</div><div style="font-size:.84rem;display:flex;gap:.5rem;flex-wrap:wrap;align-items:center;">';
  if(tr.situacion)ingHtml+='<span class="ing-badge '+SIT_CLS[tr.situacion]+'">'+SIT_LABELS[tr.situacion]+'</span>';
  if(tr.anioIngreso)ingHtml+='<span style="color:var(--muted);">Ingreso '+tr.anioIngreso+'</span>';
  if(tr.condicion)ingHtml+='<span style="color:var(--muted);">¬∑ '+COND_LABELS[tr.condicion]+'</span>';
  if(!tr.situacion&&!tr.anioIngreso)ingHtml+='<span style="color:var(--muted);font-style:italic;">Sin datos de ingreso. Completar en la pestana Ingreso.</span>';
  ingHtml+='</div>';
  if(tr.observaciones)ingHtml+='<div style="margin-top:.6rem;background:var(--paper);border-radius:8px;padding:.6rem .8rem;font-size:.83rem;color:#555;border-left:3px solid var(--gold);">'+tr.observaciones.substring(0,200)+(tr.observaciones.length>200?'‚Ä¶':'')+'</div>';
  document.getElementById('tray-resumen-ing').innerHTML=ingHtml;
}

function renderTrayIngreso(){
  const tr=getTray(trayAlumnoId);
  document.getElementById('tray-ing-situacion').value=tr.situacion||'';
  document.getElementById('tray-ing-anio').value=tr.anioIngreso||'';
  document.getElementById('tray-ing-origen').value=tr.escuelaOrigen||'';
  document.getElementById('tray-ing-condicion').value=tr.condicion||'';
  document.getElementById('tray-ing-contexto').value=tr.contexto||'';
}

function renderTrayObs(){
  const tr=getTray(trayAlumnoId);
  document.getElementById('tray-obs-texto').value=tr.observaciones||'';
  document.getElementById('tray-obs-fecha').textContent=tr.obsActualizada?'Ultima edicion: '+fmtFecha(tr.obsActualizada):'Sin observaciones aun.';
}

function saveTrayField(field,value){
  const tr=getTray(trayAlumnoId);
  tr[field]=value;
  if(field==='observaciones')tr.obsActualizada=new Date().toISOString().slice(0,10);
  saveLS();
  if(trayTabActual==='resumen')renderTrayResumen();
}

function renderTrayIntervenciones(){
  const tr=getTray(trayAlumnoId);
  const intervs=[...tr.intervenciones].sort(function(a,b){return b.fecha.localeCompare(a.fecha);});
  var h='';
  if(!intervs.length){
    h='<div style="color:var(--muted);font-size:.84rem;font-style:italic;padding:.5rem 0;">Sin intervenciones registradas.</div>';
  } else {
    intervs.forEach(function(iv){
      var tipo=TIPO_INTERV[iv.tipo]||TIPO_INTERV.otro;
      h+='<div class="interv-item">';
      h+='<div class="interv-tipo-dot it-'+iv.tipo+'" style="background:'+tipo.color+'"></div>';
      h+='<div class="interv-info">';
      h+='<div class="interv-titulo">'+tipo.label+'</div>';
      h+='<div class="interv-meta">'+fmtFecha(iv.fecha)+'</div>';
      if(iv.desc)h+='<div class="interv-desc">'+iv.desc+'</div>';
      if(iv.seguimiento)h+='<div class="interv-desc" style="color:var(--sage);margin-top:.2rem;">Seguimiento: '+iv.seguimiento+'</div>';
      h+='</div>';
      h+='<button class="btn-icon" onclick="editInterv('+iv.id+')">Edit</button>';
      h+='</div>';
    });
  }
  document.getElementById('interv-lista').innerHTML=h;
}

function abrirModalInterv(){
  document.getElementById('modal-interv-title').textContent='Nueva intervencion';
  document.getElementById('edit-interv-id').value='';
  document.getElementById('interv-fecha').value=new Date().toISOString().slice(0,10);
  document.getElementById('interv-desc').value='';
  document.getElementById('interv-seguimiento').value='';
  document.getElementById('btn-del-interv').style.display='none';
  document.querySelectorAll('.tipo-btn').forEach(function(b){b.classList.toggle('sel',b.dataset.tipo==='reunion');});
  document.getElementById('modal-interv').classList.add('open');
}

function editInterv(id){
  const tr=getTray(trayAlumnoId);
  const iv=tr.intervenciones.find(function(x){return x.id===id;});
  if(!iv)return;
  document.getElementById('modal-interv-title').textContent='Editar intervencion';
  document.getElementById('edit-interv-id').value=iv.id;
  document.getElementById('interv-fecha').value=iv.fecha;
  document.getElementById('interv-desc').value=iv.desc||'';
  document.getElementById('interv-seguimiento').value=iv.seguimiento||'';
  document.getElementById('btn-del-interv').style.display='inline-flex';
  document.querySelectorAll('.tipo-btn').forEach(function(b){b.classList.toggle('sel',b.dataset.tipo===iv.tipo);});
  document.getElementById('modal-interv').classList.add('open');
}

function selTipo(btn){
  document.querySelectorAll('.tipo-btn').forEach(function(b){b.classList.remove('sel');});
  btn.classList.add('sel');
}

function saveInterv(){
  const tipo=document.querySelector('.tipo-btn.sel')?document.querySelector('.tipo-btn.sel').dataset.tipo:'otro';
  const fecha=document.getElementById('interv-fecha').value;
  const desc=document.getElementById('interv-desc').value.trim();
  const seg=document.getElementById('interv-seguimiento').value.trim();
  if(!fecha){showToast('Selecciona una fecha');return;}
  const tr=getTray(trayAlumnoId);
  const eid=parseInt(document.getElementById('edit-interv-id').value);
  if(eid){
    const iv=tr.intervenciones.find(function(x){return x.id===eid;});
    Object.assign(iv,{tipo,fecha,desc,seguimiento:seg});
    showToast('Intervencion actualizada');
  } else {
    tr.intervenciones.push({id:newId(),tipo,fecha,desc,seguimiento:seg});
    showToast('Intervencion registrada');
  }
  closeModal('interv');saveLS();renderTrayIntervenciones();
}

function deleteIntervActual(){
  const eid=parseInt(document.getElementById('edit-interv-id').value);
  if(!confirm('Eliminar esta intervencion?'))return;
  const tr=getTray(trayAlumnoId);
  tr.intervenciones=tr.intervenciones.filter(function(x){return x.id!==eid;});
  showToast('Intervencion eliminada');
  closeModal('interv');saveLS();renderTrayIntervenciones();
}
// Limpiar service workers y cach√©s viejos
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('sw.js').catch(()=>{});
}
if('caches' in window){
  caches.keys().then(keys=>keys.forEach(k=>{
    if(k!=='profedesk-v15')caches.delete(k);
  }));
}

</script>

<!-- MODAL CONFIGURACI√ìN DRIVE -->
<div class="modal-bg" id="modal-drive-setup">
  <div class="modal">
    <div class="modal-title">‚öôÔ∏è Configurar Google Drive</div>
    <div style="font-size:.84rem;color:var(--muted);margin-bottom:1rem;">Segu√≠ estos pasos para obtener tu Client ID. Es gratis y tarda 5 minutos.</div>

    <div class="setup-step">
      <div class="setup-num">1</div>
      <div class="setup-text">
        <strong>Abr√≠ Google Cloud Console</strong>
        <a href="https://console.cloud.google.com" target="_blank" style="color:var(--sage);">console.cloud.google.com</a> ‚Üí "Nuevo proyecto" ‚Üí Nombre: <em>ProfeDesk</em> ‚Üí Crear
      </div>
    </div>
    <div class="setup-step">
      <div class="setup-num">2</div>
      <div class="setup-text">
        <strong>Habilit√° Google Drive API</strong>
        Men√∫ ‚Üí APIs y servicios ‚Üí Biblioteca ‚Üí Busc√° "Google Drive API" ‚Üí Habilitar
      </div>
    </div>
    <div class="setup-step">
      <div class="setup-num">3</div>
      <div class="setup-text">
        <strong>Cre√° credenciales OAuth</strong>
        APIs y servicios ‚Üí Credenciales ‚Üí + Crear credenciales ‚Üí ID de cliente OAuth ‚Üí Aplicaci√≥n web
      </div>
    </div>
    <div class="setup-step">
      <div class="setup-num">4</div>
      <div class="setup-text">
        <strong>Agreg√° el origen autorizado</strong>
        En "Or√≠genes autorizados de JavaScript" agreg√°: <code style="background:var(--paper);padding:.1rem .4rem;border-radius:4px;font-size:.82rem;">http://localhost:8000</code>
      </div>
    </div>
    <div class="setup-step">
      <div class="setup-num">5</div>
      <div class="setup-text">
        <strong>Peg√° tu Client ID ac√° abajo</strong>
        Copi√° el ID que termina en <em>.apps.googleusercontent.com</em>
      </div>
    </div>

    <div style="margin-top:1rem;">
      <label>Tu Client ID</label>
      <input id="drive-client-id-input" placeholder="123456789-abc123.apps.googleusercontent.com" style="font-size:.8rem;">
      <div style="font-size:.72rem;color:var(--muted);margin-top:.3rem;">Se guarda solo en este dispositivo (localStorage)</div>
    </div>

    <div class="form-actions">
      <button class="btn btn-ghost" onclick="closeModal('drive-setup')">Cancelar</button>
      <button class="btn btn-primary" onclick="saveClientId()">üíæ Guardar y conectar</button>
    </div>
  </div>
</div>


<!-- MODAL CLASE HORARIO -->
<div class="modal-bg" id="modal-clase">
  <div class="modal">
    <div class="modal-title" id="modal-clase-title">Nueva clase</div>
    <input type="hidden" id="edit-clase-id">
    <input type="hidden" id="edit-clase-dia">
    <input type="hidden" id="edit-clase-turno">
    <div class="form-row"><label>Nombre / Materia</label><input id="clase-nombre" placeholder="Ej: Econom√≠a 3¬∞B"></div>
    <div class="form-grid">
      <div class="form-row"><label>Escuela</label><select id="clase-escuela"></select></div>
      <div class="form-row"><label>Curso</label><select id="clase-curso-h"></select></div>
    </div>
    <div class="form-grid">
      <div class="form-row"><label>D√≠a</label>
        <select id="clase-dia">
          <option value="0">Lunes</option><option value="1">Martes</option>
          <option value="2">Mi√©rcoles</option><option value="3">Jueves</option><option value="4">Viernes</option>
        </select>
      </div>
      <div class="form-row"><label>Turno</label>
        <select id="clase-turno">
          <option value="manana">üåÖ Ma√±ana</option>
          <option value="tarde">‚òÄÔ∏è Tarde</option>
          <option value="noche">üåô Noche</option>
        </select>
      </div>
    </div>
    <div class="time-row">
      <div class="form-row"><label>Hora inicio</label><input type="time" id="clase-inicio"></div>
      <div class="form-row"><label>Hora fin</label><input type="time" id="clase-fin"></div>
    </div>
    <div class="form-row"><label>Color</label>
      <select id="clase-color">
        <option value="sage">üü¢ Verde (Escuela San Mart√≠n)</option>
        <option value="accent">üî¥ Rojo (Instituto Belgrano)</option>
        <option value="gold">üü° Amarillo (Colegio del Norte)</option>
        <option value="blue">üîµ Azul</option>
        <option value="purple">üü£ Violeta</option>
      </select>
    </div>
    <div class="form-actions">
      <button class="btn btn-ghost" onclick="closeModal('clase')">Cancelar</button>
      <button class="btn btn-danger btn-sm" id="btn-delete-clase" style="display:none;" onclick="deleteClaseActual()">üóëÔ∏è Eliminar</button>
      <button class="btn btn-primary" onclick="saveClase()">Guardar</button>
    </div>
  </div>
</div>


<!-- PANEL TRAYECTORIA -->
<div class="tray-overlay" id="tray-overlay" onclick="if(event.target===this)cerrarTrayectoria()">
  <div class="tray-panel">
    <div class="tray-header">
      <div class="tray-avatar" id="tray-avatar"></div>
      <div>
        <div class="tray-nombre" id="tray-nombre"></div>
        <div class="tray-sub" id="tray-sub"></div>
      </div>
      <button class="tray-close" onclick="cerrarTrayectoria()">‚úï Cerrar</button>
    </div>

    <div class="tray-tabs">
      <div class="tray-tab active" onclick="trayTab('resumen',this)">üìä Resumen</div>
      <div class="tray-tab" onclick="trayTab('ingreso',this)">üìã Ingreso</div>
      <div class="tray-tab" onclick="trayTab('observaciones',this)">üìù Observaciones</div>
      <div class="tray-tab" onclick="trayTab('intervenciones',this)">ü§ù Intervenciones</div>
    </div>

    <div class="tray-body">

      <!-- RESUMEN -->
      <div id="tray-resumen">
        <div class="tray-stats" id="tray-stats-row"></div>
        <div id="tray-resumen-notas"></div>
        <div id="tray-resumen-ing"></div>
      </div>

      <!-- INGRESO -->
      <div id="tray-ingreso" style="display:none;">
        <div class="ing-grid">
          <div class="ing-field">
            <div class="ing-label">Situaci√≥n de ingreso</div>
            <select id="tray-ing-situacion" onchange="saveTrayField('situacion',this.value)">
              <option value="">Sin especificar</option>
              <option value="nuevo">Alumno nuevo</option>
              <option value="repitente">Repitente</option>
              <option value="pase">Pase de otra escuela</option>
              <option value="reincorporado">Reincorporado</option>
            </select>
          </div>
          <div class="ing-field">
            <div class="ing-label">A√±o de ingreso</div>
            <input type="number" id="tray-ing-anio" placeholder="Ej: 2024" min="2000" max="2099" onchange="saveTrayField('anioIngreso',this.value)">
          </div>
          <div class="ing-field">
            <div class="ing-label">Escuela de origen (si es pase)</div>
            <input type="text" id="tray-ing-origen" placeholder="Nombre de la escuela" onchange="saveTrayField('escuelaOrigen',this.value)">
          </div>
          <div class="ing-field">
            <div class="ing-label">Condici√≥n</div>
            <select id="tray-ing-condicion" onchange="saveTrayField('condicion',this.value)">
              <option value="">Sin especificar</option>
              <option value="regular">Regular</option>
              <option value="libre">Libre</option>
              <option value="condicional">Condicional</option>
            </select>
          </div>
        </div>
        <div class="ing-field" style="margin-top:.3rem;">
          <div class="ing-label">Necesidades educativas / contexto familiar</div>
          <textarea id="tray-ing-contexto" rows="3" placeholder="Ej: Trabaja, tiene hijos, vive lejos, NEE diagnosticada..." onchange="saveTrayField('contexto',this.value)"></textarea>
        </div>
      </div>

      <!-- OBSERVACIONES -->
      <div id="tray-observaciones" style="display:none;">
        <div class="ing-label" style="margin-bottom:.4rem;">Observaciones generales del alumno</div>
        <textarea id="tray-obs-texto" rows="7" placeholder="Escrib√≠ ac√° todo lo que quieras recordar sobre este alumno: actitud en clase, v√≠nculos, evoluci√≥n, logros, dificultades..." style="width:100%;resize:vertical;" onchange="saveTrayField('observaciones',this.value)"></textarea>
        <div class="obs-hint">Se guarda autom√°ticamente al salir del campo.</div>

        <div style="margin-top:1.2rem;">
          <div class="ing-label" style="margin-bottom:.4rem;">√öltima actualizaci√≥n</div>
          <div id="tray-obs-fecha" style="font-size:.8rem;color:var(--muted);">‚Äî</div>
        </div>
      </div>

      <!-- INTERVENCIONES -->
      <div id="tray-intervenciones" style="display:none;">
        <div class="interv-list" id="interv-lista"></div>
        <button class="btn-add-interv" onclick="abrirModalInterv()">+ Registrar nueva intervenci√≥n</button>
      </div>

    </div>
  </div>
</div>

<!-- MODAL INTERVENCI√ìN -->
<div class="modal-bg" id="modal-interv">
  <div class="modal">
    <div class="modal-title" id="modal-interv-title">Nueva intervenci√≥n</div>
    <input type="hidden" id="edit-interv-id">
    <div class="form-row">
      <label>Tipo de intervenci√≥n</label>
      <div class="tipo-btns" id="interv-tipo-btns">
        <button class="tipo-btn sel" data-tipo="reunion" onclick="selTipo(this)">ü§ù Reuni√≥n con padres</button>
        <button class="tipo-btn" data-tipo="derivacion" onclick="selTipo(this)">üè• Derivaci√≥n</button>
        <button class="tipo-btn" data-tipo="llamado" onclick="selTipo(this)">üìû Llamado telef√≥nico</button>
        <button class="tipo-btn" data-tipo="acuerdo" onclick="selTipo(this)">üìã Acuerdo pedag√≥gico</button>
        <button class="tipo-btn" data-tipo="otro" onclick="selTipo(this)">üìå Otro</button>
      </div>
    </div>
    <div class="form-row"><label>Fecha</label><input type="date" id="interv-fecha"></div>
    <div class="form-row"><label>Descripci√≥n</label><textarea id="interv-desc" rows="3" placeholder="¬øQu√© se trat√≥? ¬øQu√© se acord√≥? ¬øQu√© resultado tuvo?"></textarea></div>
    <div class="form-row"><label>Seguimiento / pr√≥ximo paso</label><input id="interv-seguimiento" placeholder="Ej: Citar nuevamente en 2 semanas"></div>
    <div class="form-actions">
      <button class="btn btn-ghost" onclick="closeModal('interv')">Cancelar</button>
      <button class="btn btn-danger btn-sm" id="btn-del-interv" style="display:none;" onclick="deleteIntervActual()">üóëÔ∏è</button>
      <button class="btn btn-primary" onclick="saveInterv()">Guardar</button>
    </div>
  </div>
</div>

</body>
</html>
